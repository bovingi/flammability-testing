---
title: 'Clean Mixed Effects Model Selection: AIC, BIC, Mallows CP'
author: "Joe Celebrezze"
date: "2023-07-14"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
#library(lubridate)
#library(ggfortify)
library(ggpubr)
library(sjPlot) # for tab_model
library(psych) #for pairs.panels()
library(GGally) # For ggcorr()
library(scales)
library(lme4) # for lmer
#library(lmerTest) # to try stepwise selection
library(remef) # for remef
library(performance) # for multicollinearity check
library(car) # for qqPlot
library(gtools) # for combination()
library(kableExtra) # to make nice tables
library(glmmLasso) # specific to running lasso on generalized linear mixed models
library(glmnet) # 'best' package for running lasso on generalized linear models; also, has good function for cross-validation process

# defining functions
here = here::here
ggbiplot = ggbiplot::ggbiplot
source(here('scripts', 'mem.selection.function.R')) #this is where mem.selection(), mem.selection.table() and mallows.cp() functions are stored

# reading in data
flamm.df <- read.csv(here('data', 'processed-data', 'main_dataset.csv'))
```

# Data Structure

For the linear mixed effects models, we are going to be using the *flammability metrics* below as **dependent variables**:

- Flame height (fh)
- Flame duration (fd)
- Change in temp. (temp_change)
- Change in heat flux (heat_flux_change)

The following variables are not going to be considered (with the reasoning behind omitting each one described below):

- Time to ignition (tti): because this variable is conceptually meaningless for all manual ignitions (the majority of ignitions)
- Post-flame glow (pfg): because we do not necessarily trust the glow end time, as it was challenging to see in video playbacks when the sample stopped glowing. Because of this drawback, we relied on the people present during the flammability lab testing to clap at the end of the glow time, but the timing of this clap did not always correspond with the exact end of glowing
- Proportion ignited (prop_ig): because this variable has only one value for each species which does not fit the structure of the models

We have a plethora of variables that could be used as predictors and also a lot of potential covariates. The potential **predictors** are grouped and listed below:

*Species*: This will likely be included in every model, as understanding interspecific differences and grouping species by flammability is our central question

*Hydration or dryness*:
- LFM (can be total LFM, leaf LFM and/or stem LFM)
- Water potential (mpa)
- Wet weight (ww_flam_sample)* (note that this was determined to be more reminiscent of sample weight than wetness, so may not be included in the model selection)
- Dry weight (dw_flam_sample)* (note that this was determined to be more reminiscent of sample weight than dryness, so may not be included in the model selection)

*Leaf morphology*:
- LMA or SLA
- Leaf area (likely unnecessary, as described by LMA and SLA in some capacity)
- Leaf thickness

*Sample morphology*:
- Branching
- Sample density
- Branch height
- Stem to leaf ratio
- Sample weight* (note: this could also be considered a covariate)

Potential **covariates**:

- Starting temperature (start_temp)
- Sample weight* (see note above)
- Sample volume (branch_volume): could also split by height, width and length (although length is mostly the same across samples)
- Ambient humidity or temperature (note: I don't necessarily trust that the meter was doing a good job gathering this data, as it seems like the temperature of the chamber affected the measurements)
- Thermocoupler and hot plate height: probably not necessary, as exploratory analyses showed that there weren't any major differences between variables depending on the thermocoupler height or hot plate height

**Random effect**:

- Plant (to account for repeated measurements): note that we will need to make a unique identifier for each plant by combining current columns 'species' and 'plant'. Otherwise, the model will assume that (for example) plant 1 is the same group, treating HETARB 1 and SALLEU 1 as similar when they should not be treated as similar

Looking at the above variables to see how they're situated in the dataset
```{r}
# Grouping by plant_id; to check to see which traits do not have any variation per plant_id
trait.summary.plant_id <- flamm.df %>%  
  unite('plant_id', c(species, plant), sep = '_', remove = F) %>% 
  select(fh, species, lfm, leaf_lfm, stem_lfm, mpa, ww_flam_sample, dw_flam_sample, LMA, SLA, thickness, leaf_area, branching, stem_mass_ratio, leaf_mass_ratio, sample_wt, start_temp, branch_volume, branch_height, sample_density, ambient_humidity, ambient_temp, thermocoupler_height, hotplate_height, plant_id) %>% 
  mutate(lfm = scale(lfm), mpa = scale(mpa), ww_flam_sample = scale(ww_flam_sample),
         dw_flam_sample = scale(dw_flam_sample), LMA = scale(LMA), thickness = scale(thickness),
         leaf_area = scale(leaf_area), branching = scale(branching),
         leaf_mass_ratio = scale(leaf_mass_ratio), sample_wt = scale(sample_wt),
         start_temp = scale(start_temp), branch_volume = scale(branch_volume),
         sample_density = scale(sample_density), branch_height = scale(branch_height)) %>%  # scaling traits we want to look at so that standard deviations are comparable
  group_by(plant_id) %>% 
  dplyr::summarise(sd_lfm = sd(lfm), sd_mpa = sd(mpa), sd_ww = sd(ww_flam_sample), sd_dw = sd(dw_flam_sample),
                   sd_lma = sd(LMA), sd_thickness = sd(thickness), sd_leafarea = sd(leaf_area),
                   sd_branching = sd(branching), sd_leafratio = sd(leaf_mass_ratio), sd_sw = sd(sample_wt),
                   sd_st = sd(start_temp), sd_volume = sd(branch_volume),
                   sd_density = sd(sample_density), sd_bh = sd(branch_height))
trait.summary.plant_id %>% 
  mutate(sd_lfm = ifelse(is.na(sd_lfm), 0, sd_lfm),
         sd_mpa = ifelse(is.na(sd_mpa), 0, sd_mpa),
         sd_ww = ifelse(is.na(sd_ww), 0, sd_ww),
         sd_dw = ifelse(is.na(sd_dw), 0, sd_dw),
         sd_lma = ifelse(is.na(sd_lma), 0, sd_lma),
         sd_thickness = ifelse(is.na(sd_thickness), 0, sd_thickness),
         sd_leafarea = ifelse(is.na(sd_leafarea), 0, sd_leafarea),
         sd_branching = ifelse(is.na(sd_branching), 0, sd_branching),
         sd_leafratio = ifelse(is.na(sd_leafratio), 0, sd_leafratio),
         sd_sw = ifelse(is.na(sd_sw), 0, sd_sw),
         sd_st = ifelse(is.na(sd_st), 0, sd_st), 
         sd_volume = ifelse(is.na(sd_volume), 0, sd_volume),
         sd_density = ifelse(is.na(sd_density), 0, sd_density),
         sd_bh = ifelse(is.na(sd_bh), 0, sd_bh)) %>% 
  summary()

# Grouping by species; to check to see which traits do not have any intraspecific variation
trait.summary.species <- flamm.df %>%  # scaling so that standard deviations are comparable
  select(fh, species, lfm, leaf_lfm, stem_lfm, mpa, ww_flam_sample, dw_flam_sample, LMA, SLA, thickness, leaf_area, branching, stem_mass_ratio, leaf_mass_ratio, sample_wt, start_temp, branch_volume, sample_density, ambient_humidity, ambient_temp, thermocoupler_height, hotplate_height) %>% 
  mutate(lfm = scale(lfm), mpa = scale(mpa), ww_flam_sample = scale(ww_flam_sample),
         dw_flam_sample = scale(dw_flam_sample), LMA = scale(LMA), thickness = scale(thickness),
         leaf_area = scale(leaf_area), branching = scale(branching),
         leaf_mass_ratio = scale(leaf_mass_ratio), sample_wt = scale(sample_wt),
         start_temp = scale(start_temp), branch_volume = scale(branch_volume),
         sample_density = scale(sample_density)) %>%  # scaling traits we want to look at so that standard deviations are comparable
  group_by(species) %>% 
  dplyr::summarise(sd_lfm = sd(lfm), sd_mpa = sd(mpa), sd_ww = sd(ww_flam_sample), sd_dw = sd(dw_flam_sample),
                   sd_lma = sd(LMA), sd_thickness = sd(thickness), sd_leafarea = sd(leaf_area),
                   sd_branching = sd(branching), sd_leafratio = sd(leaf_mass_ratio), sd_sw = sd(sample_wt),
                   sd_st = sd(start_temp), sd_volume = sd(branch_volume),
                   sd_density = sd(sample_density))
trait.summary.species %>% 
  mutate(sd_lfm = ifelse(is.na(sd_lfm), 0, sd_lfm),
         sd_mpa = ifelse(is.na(sd_mpa), 0, sd_mpa),
         sd_ww = ifelse(is.na(sd_ww), 0, sd_ww),
         sd_dw = ifelse(is.na(sd_dw), 0, sd_dw),
         sd_lma = ifelse(is.na(sd_lma), 0, sd_lma),
         sd_thickness = ifelse(is.na(sd_thickness), 0, sd_thickness),
         sd_leafarea = ifelse(is.na(sd_leafarea), 0, sd_leafarea),
         sd_branching = ifelse(is.na(sd_branching), 0, sd_branching),
         sd_leafratio = ifelse(is.na(sd_leafratio), 0, sd_leafratio),
         sd_sw = ifelse(is.na(sd_sw), 0, sd_sw),
         sd_st = ifelse(is.na(sd_st), 0, sd_st), 
         sd_volume = ifelse(is.na(sd_volume), 0, sd_volume),
         sd_density = ifelse(is.na(sd_density), 0, sd_density)) %>% 
  summary()
```

The following plant traits are measured for each plant_id (sd = 0 for plant_id):
LFM/stem LFM/leaf LFM, LMA/SLA, thickness, leaf area, leaf ratio/stem ratio

vs. the following traits which have unique values for each plant_id:
MPa, wet weight/dry weight (note: LFM used in calculation), branching, sample weight, starting temp., sample volume

# Initial Collinearity Check
Because we have so many variables, we should look at a correlation matrix to determine which variables to include and which ones we could get rid of right away
```{r}
flamm.df <- flamm.df %>% 
  drop_na(fh, fd, pfg, temp_change, heat_flux_change) # dropping any NA's for flam. metrics

flamm.df %>% 
  select(fh, fd, pfg, temp_change, heat_flux_change, species, lfm, leaf_lfm, stem_lfm, mpa, ww_flam_sample, dw_flam_sample, LMA, SLA, thickness, leaf_area, branching, stem_mass_ratio, leaf_mass_ratio, sample_wt, start_temp, branch_volume, sample_density, ambient_humidity, ambient_temp, branch_height, thermocoupler_height, hotplate_height) %>% 
  ggcorr(label = T)
```

From the above correlation matrix, there are some initial 'problem areas':
- Sample weight and dw_flam_sample and ww_flam_sample: makes sense since sample weight was used in the calculation of these variables
- Branch volume/branch height and sample weight, dw_flam_sample, ww_flam_sample: all describe bulkiness, size of sample in some way
- LMA and SLA: duh
- Leaf mass ratio and stem mass ratio: also, duh
- Stem LFM and LFM
- Leaf area and dw_flam_sample and ww_flam_sample: more of a surprising one to me, but makes sense conceptually

So, we will eliminate some variables from contention right away:
- SLA: we can use LMA
- Stem mass ratio: we can use leaf mass ratio
- Stem LFM and leaf LFM: unless we notice something in the EDA that suggests otherwise, I think using total LFM makes sense

- Wet weight and dry weight: although these were initially thought to be important variables based on previous studies looking at tissue-level flammability, a first pass of the MEM selection showed that the sample weight component of either of these metrics was far outweighing the 'wetness' or 'dryness' component of them represented by LFM. We believe that leaving them in can be misleading to people as wet weight signifies that an increase means an increased hydration, when in many cases, it just meant an increase in weight

- Leaf area: because leaf area is included in some fashion in the calculation of LMA and due to it's oddly strong correlation to dw_flam_sample and ww_flam_sample which we're interested in keeping in the models, it makes sense to remove

We can also eliminate ambient temp and humidity since they show absolutely no correlation with flame height (and very little correlation with most variables)

# Model Selection 1: AIC, BIC
For the first model selection, going to use AIC, BIC, Mallows' CP and use the simple random effects structure (1|plant_id)

For the mem.selection() function, note the following things:
y.var must be character vector for flam. variable of interest
predictors must be dataframe w/ only predictors
df must be dataframe w/ all values
rem.str must be character vector; default is simple (1|plant_id)
the output is a list of 2 elements, the first being a dataframe with AIC, BIC, Mallows cp values and the second being a list of the mixed effects models described in the dataframe

For the mem.selection.table() function, note the following things:
df must be a the model.df output from mem.selection
mod.list must be the mod.list output from mem.selection
output is the name of the .html file you wish to save in the 'MEM' folder of figures
This function serves a dual purpose, to save a kable table in the figures and to store a dataframe of the top models in the local environment for future use (e.g., coefficients table)

## Data Wrangling
For main dataset (mem.df):
- Remove non-ignitions
- Add plant_id variable
- Select all potentially 'interesting' variables
- Scale and center them all
- Remove NA's
- Remove ARCDEN and HETARB from the analysis; after removing the above, each of these species had very few datapoints (n = 2 for HETARB, n = 8 for ARCDEN) and the random effects had only 1 datapoint in each category (plant_id) for both plants of HETARB and for 3/4 plants for ARCDEN

For predictors dataset:
- Use wrangled dataset, mem.df
- Select predictors we're interested in including in the mixed effects model selection
```{r}
mem.df <- flamm.df %>% 
  filter(ignition != '0') %>% 
  filter(species != 'ARCDEN', species != 'HETARB') %>% 
  unite('plant_id', c(species, plant), sep = '_', remove = F) %>% 
  select(species, thickness, lfm, leaf_area, LMA, sample_wt, leaf_mass_ratio, branching, mpa,
         ignition, fh, fd, tti, pfg, temp_change, heat_flux_change, prop_ig, dw_flam_sample,
         ww_flam_sample, sample_density, branch_volume, start_temp, leaf_area, branch_height,
         plant_id) %>% 
  mutate(lfm = scale(lfm), mpa = scale(mpa), ww_flam_sample = scale(ww_flam_sample),
         dw_flam_sample = scale(dw_flam_sample), sample_density = scale(sample_density),
         LMA = scale(LMA), thickness = scale(thickness),
         leaf_area = scale(leaf_area), branching = scale(branching),
         leaf_mass_ratio = scale(leaf_mass_ratio), sample_wt = scale(sample_wt),
         start_temp = scale(start_temp), branch_volume = scale(branch_volume),
         fh = scale(fh), fd = scale(fd), tti = scale(tti), pfg = scale(pfg),
         temp_change = scale(temp_change), heat_flux_change = scale(heat_flux_change),
         leaf_area = scale(leaf_area), branch_height = scale(branch_height)) %>% 
  na.omit()

mem.predictors.df <- mem.df %>% 
  select(thickness, lfm, LMA, sample_wt, leaf_mass_ratio, branching, mpa, branch_height, start_temp, leaf_area, species) # eleven predictors (note: no ww or dw)

woo <- mem.df %>% 
  mutate(n = 1) %>% 
  dplyr::group_by(plant_id) %>%
  dplyr::summarise(count = sum(n))
```

## Flame Height
```{r}
fh.mem.selection <- mem.selection('fh', mem.predictors.df, mem.df)
fh.model.df <- fh.mem.selection[[1]]
fh.mod.list <- fh.mem.selection[[2]]
fh.top.mem <- mem.selection.table(fh.model.df, fh.mod.list, 'FH_MEM.html') %>% 
  mutate(flam.var = 'fh')
```

## Flame Duration
```{r}
fd.mem.selection <- mem.selection('fd', mem.predictors.df, mem.df)
fd.model.df <- fd.mem.selection[[1]]
fd.mod.list <- fd.mem.selection[[2]]
fd.top.mem <- mem.selection.table(fd.model.df, fd.mod.list, 'FD_MEM.html') %>% 
  mutate(flam.var = 'fd')
```

## Temp. Change
```{r}
temp.mem.selection <- mem.selection('temp_change', mem.predictors.df, mem.df)
temp.model.df <- temp.mem.selection[[1]]
temp.mod.list <- temp.mem.selection[[2]]
temp.top.mem <- mem.selection.table(temp.model.df, temp.mod.list, 'TempChange_MEM.html') %>% 
  mutate(flam.var = 'temp_change')
```

## Heat Flux Change
```{r}
hf.mem.selection <- mem.selection('heat_flux_change', mem.predictors.df, mem.df)
hf.model.df <- hf.mem.selection[[1]]
hf.mod.list <- hf.mem.selection[[2]]
hf.top.mem <- mem.selection.table(hf.model.df, hf.mod.list, 'HFChange_MEM.html') %>% 
  mutate(flam.var = 'heat_flux_change')
```

## Testing 'Singular' Models
Due to the way the function above was written, every MEM had to have at least 2 predictors; however, what if the flam. metrics are better predicted by 1 predictor? The below chunk looks at each of the top predictors in 'singular' models to answer this question
```{r}
# Flame Height
fh.sw <- lmer(fh ~ sample_wt + (1|plant_id), mem.df)
AIC(fh.sw) # sig. worse than top models
BIC(fh.sw) # sig. better than top models
fh.br <- lmer(fh ~ branching + (1|plant_id), mem.df)
AIC(fh.br) # sig. worse than top models
BIC(fh.br) # sig. worse than top models

# Flame Duration
fd.sw <- lmer(fd ~ sample_wt + (1|plant_id), mem.df)
AIC(fd.sw) # sig. worse than top models
BIC(fd.sw) # sig. better than top models
fd.br <- lmer(fd ~ branching + (1|plant_id), mem.df)
AIC(fd.br) # sig. worse than top models
BIC(fd.br) # sig. worse than top models

# Temp Change
temp.sw <- lmer(temp_change ~ sample_wt + (1|plant_id), mem.df)
AIC(temp.sw) # sig. worse than top models
BIC(temp.sw) # sig. worse than top models
temp.br <- lmer(temp_change ~ branching + (1|plant_id), mem.df)
AIC(temp.br) # sig. worse than top models
BIC(temp.br) # sig. worse than top models
temp.lfm <- lmer(temp_change ~ lfm + (1|plant_id), mem.df)
AIC(temp.lfm) # sig. worse than top models
BIC(temp.lfm) # sig. worse than top models
temp.st <- lmer(temp_change ~ start_temp + (1|plant_id), mem.df)
AIC(temp.st) # sig. worse than top models
BIC(temp.st) # sig. worse than top models

# Heat Flux
hf.sw <- lmer(heat_flux_change ~ sample_wt + (1|plant_id), mem.df)
AIC(hf.sw) # not sig. different from top models
BIC(hf.sw) # sig. better than top models
hf.lmr <- lmer(heat_flux_change ~ leaf_mass_ratio + (1|plant_id), mem.df)
AIC(hf.lmr) # sig. worse than top models
BIC(hf.lmr) # sig. worse than top models
```

## Coefficients Table
Although the above tables can be helpful for mem selection, they do not provide any information about coefficients or significance of variables; below, using tab_model, we'll do just that
```{r}
top.mem <- rbind(fh.top.mem, fd.top.mem, temp.top.mem, hf.top.mem)
top.mem.list <- list()
for(i in 1:nrow(top.mem)){
  if(top.mem$flam.var[i] == 'fh'){
    top.mem.list[[i]] <- fh.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$flam.var[i] == 'fd'){
    top.mem.list[[i]] <- fd.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$flam.var[i] == 'temp_change'){
    top.mem.list[[i]] <- temp.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$flam.var[i] == 'heat_flux_change'){
    top.mem.list[[i]] <- hf.mod.list[[top.mem$model.id[i]]]
  }
}

tab_model(top.mem.list,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          string.pred = "Coeffcient", 
         title = "MEM Selection: Coefficients, Significance for Top Models",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM', 'Top_MEM_Coef.html'))
```

# Model Selection 2: LASSO
The LASSO technique is used for model selection to help us understand instances where the information criteria does not lead to solid conclusions

## Flame Height
### Lambda Cross-validation 
from https://davidabugaber.com/blog/f/find-the-optimal-mixed-model-for-your-data-with-glmmlasso
```{r}
#this loop takes much longer to run because there's more random intercepts
 
#all variables should be either continuous/numerical or factors
summary(mem.df)

#set lambdas... go from 10^-5 to 10^5, in 20 log steps (might take a while)
lambda <- 10^seq(-5,5, length=20)
 
#dummy vectors of model fit values for each lambda: BIC, AIC, prediction error
BIC_vec <- rep(Inf, length(lambda))
AIC_vec <- rep(Inf, length(lambda))
Devianz_ma<-NULL
Coeff_ma<-NULL
 
family = gaussian(link = "identity")
 
j<-1
for (j in 1:length(BIC_vec)){
 print(paste("Iteration ", j, sep=""))
 
 glm1 <- try( #throwing main variables identified by the information criteria model selection into the LASSO cross-validation process; using plant.id as random effect
 glmmLasso(fh ~ species + branching + sample_wt,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = lambda[j],
 switch.NR = TRUE,
 final.re = TRUE), 
 silent = TRUE)
 

# code to make it continue anyway if an error occurs
  if(class(glm1)!="try-error")
 { 
 
 #save BIC, AIC
 BIC_vec[j]<-glm1$bic
 AIC_vec[j]<-glm1$aic
 
 #save coefficient outputs
 Coeff_ma<-cbind(Coeff_ma,glm1$coefficients)
 
 #save error (deviance) values
 y.hat<-predict(glm1,mem.df) 
 Devianz_ma[j]<-sum(family$dev.resids(mem.df$fh,y.hat,wt=rep(1,length(y.hat)))) } }

# Best lamdas, based on different criteria
lambda[which.min(BIC_vec)]
# 69.51928
lambda[which.min(AIC_vec)]
# 1.832981
fh_lambda_bic <- lambda[which.min(BIC_vec)]
fh_lambda_aic <- lambda[which.min(AIC_vec)]
```

### Model Selection
```{r}
fh_lasso <- glmmLasso(fh ~ species + branching + sample_wt,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = fh_lambda_aic, # try both aic-based lambda and bic-based lambda
 switch.NR = TRUE,
 final.re = TRUE)

summary(fh_lasso)
```

AIC-based: branching and speciesMALLAU are both removed from consideration
BIC-based: branching, speciesMALLAU, speciesIRIDOU, speciesSALLEU are all removed from consideration
significance: sample weight and speciesERIKAR are selected as significant predictors

## Flame Duration
Because AIC/BIC based model selection came up with some solid results, we don't really need to use LASSO, but let's try it out anyways
### Lambda Cross-validation 
from https://davidabugaber.com/blog/f/find-the-optimal-mixed-model-for-your-data-with-glmmlasso
```{r}
#this loop takes much longer to run because there's more random intercepts
 
#all variables should be either continuous/numerical or factors
summary(mem.df)

#set lambdas... go from 10^-5 to 10^5, in 20 log steps (might take a while)
lambda <- 10^seq(-5,5, length=20)
 
#dummy vectors of model fit values for each lambda: BIC, AIC, prediction error
BIC_vec <- rep(Inf, length(lambda))
AIC_vec <- rep(Inf, length(lambda))
Devianz_ma<-NULL
Coeff_ma<-NULL
 
family = gaussian(link = "identity")
 
j<-1
for (j in 1:length(BIC_vec)){
 print(paste("Iteration ", j, sep=""))
 
 glm1 <- try( #throwing main variables identified by the information criteria model selection into the LASSO cross-validation process; using plant.id as random effect
 glmmLasso(fd ~ species + branching + sample_wt,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = lambda[j],
 switch.NR = TRUE,
 final.re = TRUE), 
 silent = TRUE)
 

# code to make it continue anyway if an error occurs
  if(class(glm1)!="try-error")
 { 
 
 #save BIC, AIC
 BIC_vec[j]<-glm1$bic
 AIC_vec[j]<-glm1$aic
 
 #save coefficient outputs
 Coeff_ma<-cbind(Coeff_ma,glm1$coefficients)
 
 #save error (deviance) values
 y.hat<-predict(glm1,mem.df) 
 Devianz_ma[j]<-sum(family$dev.resids(mem.df$fd,y.hat,wt=rep(1,length(y.hat)))) } }

# Best lamdas, based on different criteria
lambda[which.min(BIC_vec)]
# 6.158482
lambda[which.min(AIC_vec)]
# 20.69138
fd_lambda_bic <- lambda[which.min(BIC_vec)]
fd_lambda_aic <- lambda[which.min(AIC_vec)]
```

### Model Selection
```{r}
fd_lasso <- glmmLasso(fd ~ species + branching + sample_wt,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = fd_lambda_aic, # try both aic-based lambda and bic-based lambda
 switch.NR = TRUE,
 final.re = TRUE)

summary(fd_lasso)
```

AIC-based: speciesIRIDOU and speciesSALLEU are both removed from consideration
BIC-based: speciesIRIDOU, speciesMALLAU, speciesSALLEU, and branching removed from consideration
significance: sample weight and speciesERIKAR and SALAPI are selected as significant predictors (for both)

## Temp. Change
### Lambda Cross-validation 
from https://davidabugaber.com/blog/f/find-the-optimal-mixed-model-for-your-data-with-glmmlasso
```{r}
#this loop takes much longer to run because there's more random intercepts
 
#all variables should be either continuous/numerical or factors
summary(mem.df)

#set lambdas... go from 10^-5 to 10^5, in 20 log steps (might take a while)
lambda <- 10^seq(-5,5, length=20)
 
#dummy vectors of model fit values for each lambda: BIC, AIC, prediction error
BIC_vec <- rep(Inf, length(lambda))
AIC_vec <- rep(Inf, length(lambda))
Devianz_ma<-NULL
Coeff_ma<-NULL
 
family = gaussian(link = "identity")
 
j<-1
for (j in 1:length(BIC_vec)){
 print(paste("Iteration ", j, sep=""))
 
 glm1 <- try( #throwing main variables identified by the information criteria model selection into the LASSO cross-validation process; using plant.id as random effect
 glmmLasso(temp_change ~ species + lfm + LMA + branching + sample_wt + start_temp,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = lambda[j],
 switch.NR = TRUE,
 final.re = TRUE), 
 silent = TRUE)
 

# code to make it continue anyway if an error occurs
  if(class(glm1)!="try-error")
 { 
 
 #save BIC, AIC
 BIC_vec[j]<-glm1$bic
 AIC_vec[j]<-glm1$aic
 
 #save coefficient outputs
 Coeff_ma<-cbind(Coeff_ma,glm1$coefficients)
 
 #save error (deviance) values
 y.hat<-predict(glm1,mem.df) 
 Devianz_ma[j]<-sum(family$dev.resids(mem.df$fh,y.hat,wt=rep(1,length(y.hat)))) } }

# Best lamdas, based on different criteria
lambda[which.min(BIC_vec)]
# 0.5455595
lambda[which.min(AIC_vec)]
# 0.5455595
tc_lambda <- lambda[which.min(AIC_vec)] # since aic and bic had same results, lambda can be either/or
```

### Model Selection
```{r}
tc_lasso <- glmmLasso(temp_change ~ species + lfm + LMA + branching + sample_wt + start_temp,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = tc_lambda,
 switch.NR = TRUE,
 final.re = TRUE)

summary(tc_lasso)
```

Variables Removed: LMA, speciesERIKAR
Significance: starting temp. only significant variable

## Heat Flux Change
This one is challenging, as AIC and BIC give vastly different results..
### Lambda Cross-validation 
from https://davidabugaber.com/blog/f/find-the-optimal-mixed-model-for-your-data-with-glmmlasso
```{r}
#this loop takes much longer to run because there's more random intercepts
 
#all variables should be either continuous/numerical or factors
summary(mem.df)

#set lambdas... go from 10^-5 to 10^5, in 20 log steps (might take a while)
lambda <- 10^seq(-5,5, length=20)
 
#dummy vectors of model fit values for each lambda: BIC, AIC, prediction error
BIC_vec <- rep(Inf, length(lambda))
AIC_vec <- rep(Inf, length(lambda))
Devianz_ma<-NULL
Coeff_ma<-NULL
 
family = gaussian(link = "identity")
 
j<-1
for (j in 1:length(BIC_vec)){
 print(paste("Iteration ", j, sep=""))
 
 glm1 <- try( #throwing main variables identified by the information criteria model selection into the LASSO cross-validation process; using plant.id as random effect
 glmmLasso(heat_flux_change ~ species + sample_wt + leaf_mass_ratio + lfm + mpa,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = lambda[j],
 switch.NR = TRUE,
 final.re = TRUE), 
 silent = TRUE)
 

# code to make it continue anyway if an error occurs
  if(class(glm1)!="try-error")
 { 
 
 #save BIC, AIC
 BIC_vec[j]<-glm1$bic
 AIC_vec[j]<-glm1$aic
 
 #save coefficient outputs
 Coeff_ma<-cbind(Coeff_ma,glm1$coefficients)
 
 #save error (deviance) values
 y.hat<-predict(glm1,mem.df) 
 Devianz_ma[j]<-sum(family$dev.resids(mem.df$fh,y.hat,wt=rep(1,length(y.hat)))) } }

# Best lamdas, based on different criteria
lambda[which.min(BIC_vec)]
# 69.51928
lambda[which.min(AIC_vec)]
# 1.832981
hf_lambda_aic <- lambda[which.min(AIC_vec)]
hf_lambda_bic <- lambda[which.min(BIC_vec)]
```

### Model Selection
```{r}  
hf_lasso <- glmmLasso(heat_flux_change ~ species + sample_wt + leaf_mass_ratio + lfm + mpa,
 data=mem.df,
 rnd = list(plant_id=~1), 
 family = gaussian(link = "identity"),
 lambda = hf_lambda_bic,
 switch.NR = TRUE,
 final.re = TRUE)

summary(hf_lasso)
```

AIC: removes mpa, speciesERIKAR
BIC: removes all variables
Significance: speciesMALLAU and sample_wt are significant (only for AIC-based)

# REMEF Figures
Note: from above models, selecting top models with variables we're interested in looking at in further detail

## Flame Height
MAIN:
Branching:
```{r}
fh_mod <- lmer(fh ~ branching + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fh <- remef(fh_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
fh.branching.remef <- ggplot(mem.df, aes(x = branching, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Branching (scaled)', y = 'Flame Height') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
fh.branching.remef
#ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.fh.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = branching, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Branching (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.fh.spp.png'), width = 8, height = 5.5)
```

Sample Weight:
```{r}
fh_mod <- lmer(fh ~ sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fh <- remef(fh_mod, ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of mpa and removing the random effects to isolate the relationship between wet weight and flame height

# With REMEF
ggplot(mem.df, aes(x = sample_wt, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Sample Weight (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.fh.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = sample_wt, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Sample Weight (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.fh.spp.png'), width = 8, height = 5.5)
```

MPa:
```{r}
fh_mod <- lmer(fh ~ mpa + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fh <- remef(fh_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = mpa, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Water Potential (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'mpa.vs.fh.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = mpa, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Water Potential (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'mpa.vs.fh.spp.png'), width = 8, height = 5.5)
```

LFM:
```{r}
fh_mod <- lmer(fh ~ lfm + mpa + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fh <- remef(fh_mod, fix = c('sample_wt', 'mpa'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = lfm, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Live Fuel Moisture (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'lfm.vs.fh.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = lfm, y = r_fh))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Live Fuel Moisture (scaled)', y = 'Flame Height (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'lfm.vs.fh.spp.png'), width = 8, height = 5.5)
```

## Flame Duration
MAIN:
Branching:
```{r}
fd_mod <- lmer(fd ~ branching + sample_wt + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fd <- remef(fd_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
fd.branching.remef <- ggplot(mem.df, aes(x = branching, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Branching (scaled)', y = 'Flame Duration') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
fd.branching.remef
#ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.fd.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = branching, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Branching (scaled)', y = 'Flame Duration (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.fd.spp.png'), width = 8, height = 5.5)
```

Sample Weight:
```{r}
fd_mod <- lmer(fd ~ sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fd <- remef(fd_mod, ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = sample_wt, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 3.7)+ 
  stat_regline_equation(label.y = 4.2) +
  labs(x = 'Sample Weight (scaled)', y = 'Flame Duration (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.fd.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = sample_wt, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.2) +
  labs(x = 'Sample Weight (scaled)', y = 'Flame Duration (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.fd.spp.png'), width = 8, height = 5.5)
```

LFM: 
```{r}
fd_mod <- lmer(fd ~ lfm + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_fd <- remef(fd_mod, ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between lfm and flame height

# With REMEF
ggplot(mem.df, aes(x = lfm, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 4) +
  labs(x = 'Live Fuel Moisture (scaled)', y = 'Flame Duration (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'lfm.vs.fd.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = lfm, y = r_fd))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 0.9)+ 
  stat_regline_equation(label.y = 1.8) +
  labs(x = 'Live Fuel Moisture (scaled)', y = 'Flame Duration (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'lfm.vs.fd.spp.png'), width = 8, height = 5.5)
```

## Heat Flux Change
MAIN:
Leaf mass ratio:
```{r}
hf_mod <- lmer(heat_flux_change ~ leaf_mass_ratio + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_hf <- remef(hf_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
hf.lmr.remef <- ggplot(mem.df, aes(x = leaf_mass_ratio, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Leaf Mass Ratio (scaled)', y = 'Heat Flux Change') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
hf.lmr.remef
#ggsave(here('figures', 'MEM', 'REMEF', 'lmr.vs.heatflux.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = leaf_mass_ratio, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.25)+ 
  stat_regline_equation(label.y = 1.5) +
  labs(x = 'Leaf Mass Ratio (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'lmr.vs.heatflux.spp.png'), width = 8, height = 5.5)
```

Sample Weight:
```{r}
hf_mod <- lmer(heat_flux_change ~ sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_hf <- remef(hf_mod, ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = mpa, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Sample Weight (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.heatflux.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = mpa, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.25)+ 
  stat_regline_equation(label.y = 1.5) +
  labs(x = 'Sample Weight (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.heatflux.spp.png'), width = 8, height = 5.5)
```

Thickness:
```{r}
hf_mod <- lmer(heat_flux_change ~ thickness + sample_wt + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_hf <- remef(hf_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = thickness, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Leaf Thickness (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'thickness.vs.heatflux.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = thickness, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.25)+ 
  stat_regline_equation(label.y = 1.5) +
  labs(x = 'Leaf Thickness (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'thickness.vs.heatflux.spp.png'), width = 8, height = 5.5)
```

Leaf area:
```{r}
hf_mod <- lmer(heat_flux_change ~ leaf_area + sample_wt + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_hf <- remef(hf_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = leaf_area, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Leaf Area (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'leafarea.vs.heatflux.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = leaf_area, y = r_hf))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.25)+ 
  stat_regline_equation(label.y = 1.5) +
  labs(x = 'Leaf Area (scaled)', y = 'Heat Flux Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'leafarea.vs.heatflux.spp.png'), width = 8, height = 5.5)
```

## Temp. Change
MAIN
Branching:
```{r}
temp_mod <- lmer(temp_change ~ start_temp + branching + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_temp <- remef(temp_mod, fix = c('start_temp', 'sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
temp.branching.remef <- ggplot(mem.df, aes(x = branching, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Branching (scaled)', y = 'Temp. Change') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
temp.branching.remef
#ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.temp.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = branching, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 3.8)+ 
  stat_regline_equation(label.y = 4.3) +
  labs(x = 'Branching (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'branching.vs.temp.spp.png'), width = 8, height = 5.5)
```

Sample weight:
```{r}
temp_mod <- lmer(temp_change ~ start_temp + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_temp <- remef(temp_mod, fix = c('start_temp'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = sample_wt, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 3.6)+ 
  stat_regline_equation(label.y = 4) +
  labs(x = 'Sample Weight (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.temp.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = sample_wt, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Sample Weight (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'sw.vs.temp.spp.png'), width = 8, height = 5.5)
```

Starting Temp.
```{r}
mem.df$r_temp <- remef(temp_mod, fix = c('sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = start_temp, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 2.95)+ 
  stat_regline_equation(label.y = 3.4) +
  labs(x = 'Starting Temp. (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'starttemp.vs.temp.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = start_temp, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Starting Temp. (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'starttemp.vs.temp.spp.png'), width = 8, height = 5.5)
```

Mpa:
```{r}
temp_mod <- lmer(temp_change ~ start_temp + mpa + sample_wt + species + (1|plant_id), data = mem.df, REML = F) # remef is also sensitive to NAs

mem.df$r_temp <- remef(temp_mod, fix = c('start_temp', 'sample_wt'), ran = "all", keep.intercept = FALSE) # w/ remef, we are removing the fixed effect of wet weight and removing the random effects to isolate the relationship between mpa and flame height

# With REMEF
ggplot(mem.df, aes(x = mpa, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 1.9)+ 
  stat_regline_equation(label.y = 2.3) +
  labs(x = 'Water Potential (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'mpa.vs.temp.png'), width = 8, height = 5.5)

# Split by Species
mem.df %>%  filter(species != 'HETARB') %>% 
ggplot(aes(x = mpa, y = r_temp))  +
  geom_point(alpha = 0.8, color = 'gray20') +
  geom_smooth(method = 'lm', color = 'gray40') +
  facet_wrap(~species, scales = 'free') +
  stat_cor(label.y = 3.8)+ 
  stat_regline_equation(label.y = 4.3) +
  labs(x = 'Water Potential (scaled)', y = 'Temp. Change (effects removed, scaled)') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 15),
        axis.text = element_text(size = 12))
ggsave(here('figures', 'MEM', 'REMEF', 'mpa.vs.temp.spp.png'), width = 8, height = 5.5)
```

## Arranged
```{r}
ggarrange(fh.branching.remef, fd.branching.remef, temp.branching.remef, hf.lmr.remef,
          labels = c('A', 'B', 'C', 'D'), 
          font.label = list(size = 28),
          ncol = 2, nrow = 2)
ggsave(here('figures', 'main_figures', 'remef.scatterplots.png'), height = 8, width = 10)
```

# Testing for Interactions
Using ChatGPT generated code, integrated with my previously made function
```{r}
# Defining predictors we're interested in as a character vector
predictors <- c('thickness', 'lfm', 'LMA', 'sample_wt', 'leaf_mass_ratio', 'branching', 'mpa', 'branch_height', 'start_temp', 'leaf_area', 'species')

# NOTE: y.var and rem.str must be a character vector, predictors must be a dataframe
mem.int.selection <- function(y.var, predictors, df, rem.str = '(1|plant_id)'){
# FIRST: List models
# Generate all possible combinations of two predictors for interaction
interaction_combinations <- combn(predictors, 2, simplify = FALSE)

# Create an empty list to store model results
mod.list <- list()

# Loop through the interaction combinations
for (combo in interaction_combinations) {
  # Create the formula for the model (e.g., outcome ~ predictor1 * predictor2)
  formula <- as.formula(paste(y.var, "~", paste(combo, collapse = "*"), "+", rem.str))
  
  # Fit the mixed-effects model
  model <- lmer(formula, data = mem.df)
  
  # Store the model result in the list
  mod.list[[paste(combo, collapse = "_")]] <- model
}
  
  # CREATE DATAFRAME
  model.df <- data.frame(model.id = c(1:length(mod.list)),
                         call = c(rep(NA, length(mod.list))),
                         multicollinearity = c(rep(NA, length(mod.list))),
                         AIC = c(rep(NA, length(mod.list))),
                         BIC = c(rep(NA, length(mod.list))),
                         CP = c(rep(NA, length(mod.list))))
  
  # SECOND: FLAG ANY MODELS THAT BREAK MULTICOLINEARITY ASSUMPTIONS
  for(i in 1:length(mod.list)){
    vif.df <- multicollinearity(mod.list[[i]])
    ifelse(max(vif.df$VIF) > 5, model.df$multicollinearity[i] <- 'yes', 
           model.df$multicollinearity[i] <- 'no')
  }
  
  for(i in 1:length(mod.list)){
    if(model.df$multicollinearity[i] == 'yes'){
      mod.list[[i]] <- NA
    }}
  
  # THIRD: CALCULATE AIC, BIC, MALLOWS CP
  for(i in 1:length(mod.list)) {
    if(model.df$multicollinearity[i] == 'yes')
    {model.df[i, 3:6] <- NA}
    else{
      model.df$call[i] <- paste(colnames(mod.list[[i]]@frame), collapse = ', ')
      model.df$AIC[i] <- AIC(mod.list[[i]])
      model.df$BIC[i] <- BIC(mod.list[[i]])
      model.df$CP[i] <- mallows.cp(mod.list[[i]], k = length(mod.list[[i]]@beta - 1), n = nrow(df))
    }
  }
  output <- list(model.df, mod.list)
  return(output)
}
```

## Flame Height
```{r}
fh.mem.int.selection <- mem.int.selection('fh', predictors, mem.df)
fh.int.model.df <- fh.mem.int.selection[[1]]
fh.int.mod.list <- fh.mem.int.selection[[2]]

# top performing interaction terms: LFM*sample_wt (AIC = 336.8), branching*sample_wt (AIC = 337.3), mpa*sample_wt (AIC = 340.7), leaf_mass_ratio*sample_wt (AIC = 344.1); all sig. worse than top-performing models w/o interactions

# testing models w/ interaction terms
fh.int.mod.list[[56]] <- lmer(fh ~ lfm*sample_wt + species + (1|plant_id), data = mem.df)
AIC(fh.int.mod.list[[56]])
fh.int.mod.list[[57]] <- lmer(fh ~ branching*sample_wt + species + (1|plant_id), data = mem.df)
AIC(fh.int.mod.list[[57]])
fh.int.mod.list[[58]] <- lmer(fh ~ branching*sample_wt + lfm + (1|plant_id), data = mem.df)
AIC(fh.int.mod.list[[58]])
fh.int.mod.list[[59]] <- lmer(fh ~ lfm*sample_wt + branching + (1|plant_id), data = mem.df)
AIC(fh.int.mod.list[[59]]) # significantly better than any model w/o interactions!!!
fh.int.mod.list[[60]] <- lmer(fh ~ lfm*sample_wt + branching + species + (1|plant_id), data = mem.df)
AIC(fh.int.mod.list[[60]])
```

## Flame Duration
```{r}
fd.mem.int.selection <- mem.int.selection('fd', predictors, mem.df)
fd.int.model.df <- fd.mem.int.selection[[1]]
fd.int.mod.list <- fd.mem.int.selection[[2]]

# top performing interaction terms: LFM*sample_wt (AIC = 437.1, not sig. worse than top-performing model w/o interactions), branching*sample_wt (AIC = 442.4), LMA*sample_wt (AIC = 443.5)

# testing models w/ interaction terms
fd.int.mod.list[[56]] <- lmer(fd ~ lfm*sample_wt + species + (1|plant_id), data = mem.df)
BIC(fd.int.mod.list[[56]]) # not sig. worse than top-performing model
fd.int.mod.list[[57]] <- lmer(fd ~ branching*sample_wt + species + (1|plant_id), data = mem.df)
AIC(fd.int.mod.list[[57]])
fd.int.mod.list[[58]] <- lmer(fd ~ branching*sample_wt + lfm + (1|plant_id), data = mem.df)
AIC(fd.int.mod.list[[58]])
fd.int.mod.list[[59]] <- lmer(fd ~ lfm*sample_wt + branching + (1|plant_id), data = mem.df)
AIC(fd.int.mod.list[[59]]) # not sig. worse than top-performing model
fd.int.mod.list[[60]] <- lmer(fd ~ lfm*sample_wt + branching + species + (1|plant_id), data = mem.df)
AIC(fd.int.mod.list[[60]])
```

## Temp. Change
```{r}
temp.mem.int.selection <- mem.int.selection('temp_change', predictors, mem.df)
temp.int.model.df <- temp.mem.int.selection[[1]]
temp.int.mod.list <- temp.mem.int.selection[[2]]

# top-performing interaction terms: sample_wt*start_temp (AIC = 386.6; better than top-performing model w/o interactions!!), lfm*start_temp (AIC = 389.5), branch_height*start_temp (AIC = 391.6)

# testing models w/ interaction terms
temp.int.mod.list[[56]] <- lmer(temp_change ~ start_temp*sample_wt + species + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[56]]) # not sig. worse than top-performing model
temp.int.mod.list[[57]] <- lmer(temp_change ~ lfm*start_temp + species + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[57]])
temp.int.mod.list[[58]] <- lmer(temp_change ~ branch_height*start_temp + species + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[58]])
temp.int.mod.list[[59]] <- lmer(temp_change ~ start_temp*sample_wt + lfm + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[59]]) # sig. better than top performing model! AIC = 380.7
temp.int.mod.list[[60]] <- lmer(temp_change ~ lfm*start_temp + sample_wt + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[60]])
temp.int.mod.list[[61]] <- lmer(temp_change ~ branch_height*start_temp + sample_wt + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[61]])
temp.int.mod.list[[62]] <- lmer(temp_change ~ start_temp*sample_wt + branching + (1|plant_id), data = mem.df)
AIC(temp.int.mod.list[[62]]) # sig. better than top performing model! AIC = 376.71
```

## Heat Flux Change
```{r}
hf.mem.int.selection <- mem.int.selection('heat_flux_change', predictors, mem.df)
hf.int.model.df <- hf.mem.int.selection[[1]]
hf.int.mod.list <- hf.mem.int.selection[[2]]

# top performing interaction terms: leaf_mass_ratio*sample_wt (AIC = 375.8, sig. better than top-performing model w/o interactions!), LFM*sample_wt (AIC = 383.2), start_temp*sample_wt (AIC = 383.5)

# testing models w/ interaction terms
hf.int.mod.list[[56]] <- lmer(heat_flux_change ~ leaf_mass_ratio*sample_wt + species + (1|plant_id), data = mem.df)
BIC(hf.int.mod.list[[56]]) # AIC = 365.1, sig. best model
hf.int.mod.list[[57]] <- lmer(heat_flux_change ~ leaf_mass_ratio*sample_wt + lfm + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[57]]) # AIC = 379.9
hf.int.mod.list[[58]] <- lmer(heat_flux_change ~ leaf_mass_ratio*sample_wt + start_temp + (1|plant_id), data = mem.df)
BIC(hf.int.mod.list[[58]]) # AIC = 380.48
hf.int.mod.list[[59]] <- lmer(heat_flux_change ~ lfm*sample_wt + leaf_mass_ratio + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[59]])
hf.int.mod.list[[60]] <- lmer(heat_flux_change ~ lfm*sample_wt + species + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[60]]) 
hf.int.mod.list[[61]] <- lmer(heat_flux_change ~ lfm*sample_wt + start_temp + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[61]])
hf.int.mod.list[[62]] <- lmer(heat_flux_change ~ start_temp*sample_wt + leaf_mass_ratio + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[62]])
hf.int.mod.list[[63]] <- lmer(heat_flux_change ~ start_temp*sample_wt + species + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[63]]) # AIC = 379.55
hf.int.mod.list[[64]] <- lmer(heat_flux_change ~ start_temp*sample_wt + lfm + (1|plant_id), data = mem.df)
AIC(hf.int.mod.list[[64]])
```