---
title: "Thermocouple Temp. Data"
author: "Joe Celebrezze"
date: "2023-03-03"
output: html_document
---

Data cleaning prior to R: 
- Delete first rows of thermocoupler data

# Set-up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(hms)
library(caret) # for optimization routine

# defining functions
here = here::here

# reading in data
thermocoupler.files <- list.files(here('data', 'raw-data', 'thermocouplers'))
thermocoupler.df.list <- list()
for(i in 1:length(thermocoupler.files)){
  df <- read.csv(here('data', 'raw-data', 'thermocouplers', thermocoupler.files[[i]]))
  thermocoupler.df.list[[i]] <- df
}

flam.df <- read.csv(here('data', 'raw-data', 'flamm', 'burn_samples_flamm_clocktime.csv'))
```

# Data Wrangling
## Thermocoupler data
```{r}
# Combining thermocoupler datasheets
thermocoupler.df <- do.call('rbind', thermocoupler.df.list)

# Getting temperature data in correct format
for(i in 4:11){
thermocoupler.df[,i] <- thermocoupler.df[,i] %>% 
  str_replace(pattern = '\\+ ', replacement = ' ') %>% 
  str_trim(side = c('left'))
thermocoupler.df[,i] <- as.numeric(thermocoupler.df[,i])
}
thermocoupler.df <- na.omit(thermocoupler.df)

# Splitting date and time into two columns
thermocoupler.df <- thermocoupler.df %>% 
  mutate(Date.Time = as.POSIXct(Date.Time) + 80) %>%  # Adjusting time so it matches time on clock
  mutate(date = as.Date(Date.Time)) %>% 
  mutate(time = format(as.POSIXct(Date.Time), format = "%H:%M:%S")) %>% 
  mutate(time = as_hms(time))

# For heat flux
heatflux.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6, CH7, CH8)
heatflux.df.long <- heatflux.df %>% 
  select(date, time, ms, CH7, CH8) %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'sensor.id',
               values_to = 'heat.flux')

# Removing unncessary columns
thermocoupler.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6)

# Lengthening dataframe
thermocoupler.df.long <- thermocoupler.df %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'thermo.id',
               values_to = 'temp')

# Combining dataframes
temp.heat.flux.df <- merge(thermocoupler.df.long, heatflux.df.long, by = c('date', 'time', 'ms'))
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(sensor.location = case_when(
    sensor.id == 'CH7' ~ 'Top',
    sensor.id == 'CH8' ~ 'Left Side'
  ))
```

## Flamm data
Wrangling clocktime .csv, cleaning columns, etc.
```{r}
flam.df.clean <- flam.df %>% 
  mutate(start_time = start_time_clocktime) %>% 
  mutate(primary_ignition = firstigstart_time_clock_time) %>% 
  mutate(primary_time_of_flame_end = firstigend_time_clock_time) %>% 
  mutate(secondary_ignition = secondigstart_time_clock_time) %>% 
  mutate(secondary_time_of_flame_end = secondigend_time_clock_time) %>% 
  mutate(time_of_glow_end = end_time_clock_time) %>% 
  mutate(time_fh = maxflameht_time_clock_time) %>% 
  select(-c(start_time_clocktime, firstigstart_time_clock_time, firstigend_time_clock_time, secondigstart_time_clock_time, secondigend_time_clock_time, end_time_clock_time, maxflameht_time_clock_time))

flam.df.clean <- replace(flam.df.clean, flam.df.clean=='', NA)

flam.df.clean <- flam.df.clean %>% 
  mutate(start_time = as_hms(format(as.POSIXct(start_time), format = "%H:%M:%S"))) %>% 
  mutate(primary_ignition = as_hms(format(as.POSIXct(primary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(primary_time_of_flame_end = as_hms(format(as.POSIXct(primary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(secondary_ignition = as_hms(format(as.POSIXct(secondary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(secondary_time_of_flame_end = as_hms(format(as.POSIXct(secondary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(time_of_glow_end = as_hms(format(as.POSIXct(time_of_glow_end), format = "%H:%M:%S"))) %>% 
  mutate(time_fh = as_hms(format(as.POSIXct(time_fh), format = "%H:%M:%S")))
```

```{r}
# Getting the time and date in the right format
flam.df <- flam.df.clean %>% 
  mutate(pre_ignition_glow = as.numeric(pre_ignition_glow)) %>% 
  mutate(fh = as.numeric(fh)) %>% 
  mutate(date = as.Date(date)) %>% 
  # FLAME DURATION
  mutate(fd = primary_time_of_flame_end - primary_ignition) %>% 
  mutate(fd = as.numeric(fd)) %>% 
  # TIME TO IGNITION
  mutate(tti = primary_ignition - start_time) %>% 
  mutate(tti = as.numeric(tti)) %>% 
  # POST FLAME GLOW
  mutate(pfg = time_of_glow_end - primary_time_of_flame_end) %>% 
  mutate(pfg = as.numeric(pfg))
```

Flam Data 2: dealing with some more complex data wrangling

Glow metrics
```{r}
# Glow duration, time to first glow, glow to ignition; for this, we need to get the first_glow_time in hms format; however, this was more challenging than expected. My proposed solution to deal with this problem is to split the dataframe in two -- one with N/A values and one with HH:MM:SS -- before using as_hms and calculating the above glow metrics
flam.df.na <- flam.df %>% 
  filter(pre_ignition_glow == 0) %>% 
  mutate(first_glow_time = NA) %>% 
  mutate(gd = NA) %>% 
  mutate(gti = NA) %>% 
  mutate(ttfg = NA)

flam.df.no.na <- flam.df %>% 
  filter(pre_ignition_glow == 1) %>% 
  mutate(first_glow_time = as_hms(first_glow_time)) %>% 
  mutate(gd = time_of_glow_end - first_glow_time) %>% 
  mutate(gti = primary_ignition - first_glow_time) %>% 
  mutate(ttfg = first_glow_time - start_time)

flam.df <- rbind(flam.df.na, flam.df.no.na)
```

# Calculating Max. Temp.
Note: looking at different time spans for exploratory analysis; using CH5 and CH1
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_temp_flamehtCH1 = NA) %>% 
  mutate(time_at_max_temp_flamehtCH1 = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>%
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$time_fh[i]-2 & time <= flam.df$time_fh[i] + 2) %>% 
    filter(thermo.id == 'CH1')
  flam.df$max_temp_flamehtCH1[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp_flamehtCH1[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp_flamehtCH1[i] <- df.mt$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp_flamehtCH1 = as_hms(time_at_max_temp_flamehtCH1))
```

# Calculating Starting Temp.
(and temperature change)
```{r}
flam.df <- flam.df %>% 
  mutate(start_tempCH5 = NA)
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>% 
    filter(time == flam.df$start_time[i]) %>% 
    filter(ms == 0) %>% 
    filter(thermo.id == 'CH5')
  flam.df$start_tempCH5[i] <- max(df$temp)
}
flam.df <- flam.df %>% 
  mutate(temp_change = max_temp - start_temp)
```

# Calculating Average Temp. Pre-ignition
```{r}
flam.df <- flam.df %>% 
  mutate(avg_temp_flamehtCH1 = NA) %>% 
  mutate(time_at_max_temp_flamehtCH1 = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>%
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$time_fh[i]-2 & time <= flam.df$time_fh[i] + 2) %>% 
    filter(thermo.id == 'CH1')
  flam.df$max_temp_flamehtCH1[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp_flamehtCH1[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp_flamehtCH1[i] <- df.mt$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp_flamehtCH1 = as_hms(time_at_max_temp_flamehtCH1))
```


# Calculating Max Heat Flux
## Option 1
Maximum heat flux value over the course of the test
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_flameminus5 = NA) %>% 
  mutate(time_at_max_heat_flux_flameminus5 = NA)
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(max_heat_flux = NA) 
for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i]-5 & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    filter(sensor.id == 'CH8') #again, index row, select columns
  flam.df$max_heat_flux_flameminus5[i] <- max(df$heat.flux)
  df$max_heat_flux <- case_when(df$heat.flux == flam.df$max_heat_flux_flameminus5[i] ~ 'yes')
  df.mhf <- df %>% 
    filter(max_heat_flux == 'yes')
  flam.df$time_at_max_heat_flux_flameminus5[i] <- df.mhf$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_heat_flux_flameminus5 = as_hms(time_at_max_heat_flux_flameminus5))
```

## Option 2
Using Loess smoothed regression and calculating maximum peak (for each sensor); leaning towards side sensor based on smaller signal-to-noise ratio

```{r}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_flame_loessCH7 = NA) %>% 
  mutate(time_at_max_heat_flux_flame_loessCH7 = NA) %>% 
  mutate(max_heat_flux_flame_loessCH8 = NA) %>% 
  mutate(time_at_max_heat_flux_flame_loessCH8 = NA)
heatflux.df <- heatflux.df %>% 
  mutate(max_heat_flux_loessCH7 = NA)  %>% 
  mutate(max_heat_flux_loessCH8 = NA)
# NOTE: THIS PART WILL NOT BE NECESSARY WHEN ALL DATALOGGER DATA IS INPUTTED
flam.df.no.Inf <- flam.df %>% 
  filter(max_heat_flux > 0)
flam.df.Inf <- flam.df %>% 
  filter(max_heat_flux < 0) 

for(i in 1:nrow(flam.df.no.Inf)){
  df <- heatflux.df %>% 
    filter(date == flam.df.no.Inf$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.no.Inf$primary_ignition[i] & time <= flam.df.no.Inf$primary_time_of_flame_end[i]) %>% #again, index row, select columns
    mutate(time = as.numeric(time))
  
# Loess regressions
  loess.mod.CH7 <- loess(CH7 ~ time, data = df, span = 0.3)
  df$loess.CH7 <- predict(loess.mod.CH7)
  loess.mod.CH8 <- loess(CH8 ~ time, data = df, span = 0.3)
  df$loess.CH8 <- predict(loess.mod.CH8)

  flam.df.no.Inf$max_heat_flux_flame_loessCH7[i] <- max(df$loess.CH7)
  flam.df.no.Inf$max_heat_flux_flame_loessCH8[i] <- max(df$loess.CH8)
  
  df$max_heat_flux_loessCH7 <- case_when(df$loess.CH7 == flam.df.no.Inf$max_heat_flux_flame_loessCH7[i] ~ 'yes')
  df$max_heat_flux_loessCH8 <- case_when(df$loess.CH8 == flam.df.no.Inf$max_heat_flux_flame_loessCH8[i] ~ 'yes')
  
  df.mhf_CH7 <- df %>% 
    filter(max_heat_flux_loessCH7 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_flame_loessCH7[i] <- df.mhf_CH7$time[1]
  df.mhf_CH8 <- df %>% 
    filter(max_heat_flux_loessCH8 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_flame_loessCH8[i] <- df.mhf_CH8$time[1]
}
flam.df.no.Inf <- flam.df.no.Inf %>% 
  mutate(time_at_max_heat_flux_flame_loessCH7 = as_hms(time_at_max_heat_flux_flame_loessCH7)) %>% 
  mutate(time_at_max_heat_flux_flame_loessCH8 = as_hms(time_at_max_heat_flux_flame_loessCH8))

flam.df <- rbind(flam.df.no.Inf, flam.df.Inf)
```

```{r}
heatflux.vis <- function(index){
heatflux.df.woop <- heatflux.df %>% 
  filter(date == flam.df.no.Inf$date[index]) %>%  #index row, select column for date
  filter(time >= flam.df.no.Inf$start_time[index] & time <= flam.df.no.Inf$time_of_glow_end[index]) %>% 
  mutate(time = as.numeric(time))

loess.mod.CH7 <- loess(CH7 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0983)
heatflux.df.woop$loess.CH7 <- predict(loess.mod.CH7)

ch7.title <- paste('Top Sensor (span = 0.0983)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.top <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH7), color = 'black') +
  geom_point(aes(y = CH7), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.95, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], y = 1, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Top Sensor)', title = ch7.title) +
  theme_bw() + 
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))

loess.mod.CH8 <- loess(CH8 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0261)
heatflux.df.woop$loess.CH8 <- predict(loess.mod.CH8)

ch8.title <- paste('Side Sensor (span = 0.0261)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.side <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH8), color = 'black') +
  geom_point(aes(y = CH8), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.5, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], y = 0.55, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Side Sensor)', title = ch8.title) +
  theme_bw() +  
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))
print(plot.side)
print(plot.top)
}
```

```{r}
heatflux.vis(2)
```


## Optimizing Smoothing Span
```{r, warning = F}
flam.df.no.Inf.no.non.ig <- flam.df.no.Inf %>% 
  filter(ignition != '0')
flam.df.sample <- sample_n(flam.df.no.Inf.no.non.ig, 40)

CH7results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 40,
                          ncol = 8))
colnames(CH7results) <- colnames(best)

CH8results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 40,
                          ncol = 8))
colnames(CH8results) <- colnames(best)

ctrl <- trainControl(method = "cv", number = 5)
grid <- expand.grid(span = seq(0.01, 0.5, len = 40), degree = 1)

for(i in 1:length(flam.df.sample)){
  df <- heatflux.df %>% 
    filter(date == flam.df.sample$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.sample$time_fh[i]-2 & time <= flam.df.sample$time_fh[i]+2) %>% 
    mutate(time = as.numeric(time))
  
  CH7model <- train(CH7 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)
  
  CH8model <- train(CH8 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)

  ch7.res <- as.data.frame(CH7model$results)
  ch7.best <- ch7.res[which.min(ch7.res$RMSE),]
  CH7results[i,] <- ch7.best
  
  ch8.res <- as.data.frame(CH8model$results)
  ch8.best <- ch8.res[which.min(ch8.res$RMSE),]
  CH8results[i,] <- ch8.best
}

CH7results <- na.omit(CH7results)
mean(CH7results$span) # 0.0691

CH8results <- na.omit(CH8results)
mean(CH8results$span) # 0.0337
```

# Average Heat Flux of Flame Duration
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH7') %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
```


# Visualization
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('thermocoupler_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i],  '_ignition=', flam.df$ignition[i])
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = temp, color = thermo.id)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

# Comparing Different Timespans of Max Temp
Note that this will not work after removing environment as I tweaked the same chunk of code a bunch of times to calculate all of the timespans (I don't really care because just need the figure); if we want it to be permanent, then I can do that. 
## CH1 
```{r}
library(ggpubr)
p1 <- ggplot(flam.df, aes(x = max_temp_fulldurCH1, y = max_temp_flameminus5CH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration + 5 seconds prior')
p1

p2 <- ggplot(flam.df, aes(x = max_temp_fulldurCH1, y = max_temp_flameCH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration')
p2

p3 <- ggplot(flam.df, aes(x = max_temp_flameminus5CH1, y = max_temp_flameCH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Duration')
p3

p4 <- ggplot(flam.df, aes(x = max_temp_fulldurCH1, y = max_temp_flamehtCH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  labs(x = 'Full Test', y = 'Flame Height +/- 2 seconds')
p4

p5 <- ggplot(flam.df, aes(x = max_temp_flameminus5CH1, y = max_temp_flamehtCH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Height +/- 2 seconds')
p5

p6 <- ggplot(flam.df, aes(x = max_temp_flameCH1, y = max_temp_flamehtCH1))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration', y = 'Flame Height +/- 2 seconds')
p6

blank <- ggplot(flam.df, aes(x = max_temp_flameCH1, y = max_temp_flamehtCH1)) +
  theme_void()
blank

ggarrange(p1, blank, blank, p2, p3, blank, p4, p5, p6, ncol = 3, nrow = 3, widths = c(1,1,1), heights = c(1,1,1))
```

### Time elapsed
```{r}
p1 <- ggplot(flam.df, aes(x = time_at_max_temp_fulldurCH5-start_time, y = time_at_max_temp_flameminus5CH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration + 5 seconds prior')
p1

p2 <- ggplot(flam.df, aes(x = time_at_max_temp_fulldurCH5-start_time, y = time_at_max_temp_flameCH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration')
p2

p3 <- ggplot(flam.df, aes(x = time_at_max_temp_flameminus5CH5-start_time, y = time_at_max_temp_flameCH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Duration')
p3

p4 <- ggplot(flam.df, aes(x = time_at_max_temp_fulldurCH5-start_time, y = time_at_max_temp_flamehtCH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  labs(x = 'Full Test', y = 'Flame Height +/- 2 seconds')
p4

p5 <- ggplot(flam.df, aes(x = time_at_max_temp_flameminus5CH5-start_time, y = time_at_max_temp_flamehtCH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Height +/- 2 seconds')
p5

p6 <- ggplot(flam.df, aes(x = time_at_max_temp_flameCH5-start_time, y = time_at_max_temp_flamehtCH5-start_time))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration', y = 'Flame Height +/- 2 seconds')
p6

ggarrange(p1, blank, blank, p2, p3, blank, p4, p5, p6, ncol = 3, nrow = 3, widths = c(1,1,1), heights = c(1,1,1))
```


## CH5 
```{r}
p1 <- ggplot(flam.df, aes(x = max_temp_fulldurCH5, y = max_temp_flameminus5CH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration + 5 seconds prior')
p1

p2 <- ggplot(flam.df, aes(x = max_temp_fulldurCH5, y = max_temp_flameCH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration')
p2

p3 <- ggplot(flam.df, aes(x = max_temp_flameminus5CH5, y = max_temp_flameCH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Duration')
p3

p4 <- ggplot(flam.df, aes(x = max_temp_fulldurCH5, y = max_temp_flamehtCH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  labs(x = 'Full Test', y = 'Flame Height +/- 2 seconds')
p4

p5 <- ggplot(flam.df, aes(x = max_temp_flameminus5CH5, y = max_temp_flamehtCH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Height +/- 2 seconds')
p5

p6 <- ggplot(flam.df, aes(x = max_temp_flameCH5, y = max_temp_flamehtCH5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration', y = 'Flame Height +/- 2 seconds')
p6

ggarrange(p1, blank, blank, p2, p3, blank, p4, p5, p6, ncol = 3, nrow = 3, widths = c(1,1,1), heights = c(1,1,1))
```

## Heat Flux (CH8)
```{r}
p1 <- ggplot(flam.df, aes(x = max_heat_flux, y = max_heat_flux_flameminus5))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration + 5 seconds prior')
p1

p2 <- ggplot(flam.df, aes(x = max_heat_flux, y = max_heat_flux_flame))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  labs(x = 'Full Test', y = 'Flame Duration')
p2

p3 <- ggplot(flam.df, aes(x = max_heat_flux_flameminus5, y = max_heat_flux_flame))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Duration')
p3

p4 <- ggplot(flam.df, aes(x = max_heat_flux, y = max_heat_flux_flameht))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +  
  labs(x = 'Full Test', y = 'Flame Height +/- 2 seconds')
p4

p5 <- ggplot(flam.df, aes(x = max_heat_flux_flameminus5, y = max_heat_flux_flameht))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration + 5 seconds prior', y = 'Flame Height +/- 2 seconds')
p5

p6 <- ggplot(flam.df, aes(x = max_heat_flux_flame, y = max_heat_flux_flameht))  +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  geom_abline(color = 'gray50', alpha = 0.65) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = 'Flame Duration', y = 'Flame Height +/- 2 seconds')
p6

ggarrange(p1, blank, blank, p2, p3, blank, p4, p5, p6, ncol = 3, nrow = 3, widths = c(1,1,1), heights = c(1,1,1))
```

Plots
```{r}
shaboom <- flam_sierra_df %>% 
  filter(ignition == '1') %>% 
  select(taller_temp_max, taller_temp_start) %>% 
  drop_na(taller_temp_max) %>% 
  mutate(temp_change = taller_temp_max - taller_temp_start)
mean(shaboom$taller_temp_max)
sd(shaboom$taller_temp_max)
mean(shaboom$taller_temp_start)
sd(shaboom$taller_temp_start)
mean(shaboom$temp_change)
sd(shaboom$temp_change)

# Lower: MT - 319 sd 69, ST - 258.5 sd 21.8, TC - 60.6 sd 65.6
# Upper: MT - 264 sd 39, ST - 215 sd 19, TC - 48.7 sd 39.9

WHAM <- flam.df %>% 
  filter(ignition == '1') %>% 
  select(max_temp, start_temp) %>% 
  filter(max_temp > 0) %>% 
  drop_na(max_temp) %>% 
  mutate(temp_change = max_temp - start_temp)
mean(WHAM$max_temp)
sd(WHAM$max_temp)
mean(WHAM$start_temp)
sd(WHAM$start_temp)
mean(WHAM$temp_change)
sd(WHAM$temp_change)

# CH1: MT - 170.7 sd 13.4, ST - 158 sd 15.1, TC - 12.7 sd 8
# CH2: MT - 177.8 sd 30.9, ST - 169.6 sd 30, TC - 8.1 sd 9.2
# CH3: MT - 227.6 sd 14.5, ST - 213 sd 14.3, TC - 14.5 sd 8.5
# CH4: MT - 211.2 sd 11.4, ST - 198.9 sd 11.1, TC - 12.4 sd 6.6
# CH5: MT - 138.7 sd 8.2, ST - 122 sd 12.7, TC - 16.7 sd 9.4
# CH6: MT - 125.3 sd 20, ST - 115 sd 20, TC - 9.9 sd 10

plot.list[[7]]
plot.list[[17]]
plot.list[[19]]
plot.list[[23]]
plot.list[[28]]
plot.list[[31]]
plot.list[[51]]
plot.list[[54]]
plot.list[[65]]
plot.list[[78]]
plot.list[[80]]
plot.list[[82]]
plot.list[[88]]
plot.list[[90]]
plot.list[[149]]
plot.list[[237]]
plot.list[[227]]
plot.list[[231]]
plot.list[[267]]
plot.list[[273]]
plot.list[[274]]
plot.list[[276]]
plot.list[[277]]
plot.list[[279]]
plot.list[[283]]
plot.list[[288]]
plot.list[[295]]
plot.list[[297]]
plot.list[[301]]
plot.list[[302]]
plot.list[[307]]
plot.list[[314]]
plot.list[[321]]
plot.list[[322]]
plot.list[[325]]
plot.list[[348]]
```

HETARB shows very low temperatures for 4/6 thermocouples. What is going on?
```{r}
thermocoupler.df.long %>% 
    ggplot(aes(x = time, y = temp, color = thermo.id)) +
      geom_point(size = 0.4) +
      theme_bw() +
      labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID",
           title = "Differences Between Dates") +
      facet_wrap(~date, ncol = 1) +
      theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
```

# Heat Flux
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('heatflux_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])
  
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = heat.flux, color = sensor.location)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 1.4, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 1.3, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'Max. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 1.5, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Heat Flux", color = "Sensor Location", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

Plots
```{r}
plot.list[[1]]
plot.list[[4]]
plot.list[[7]]
plot.list[[16]]
plot.list[[20]]
plot.list[[47]]
plot.list[[69]]
plot.list[[71]]
plot.list[[73]]
plot.list[[99]]
```

# Temp and Heat Flux
Investigating differences between manual ignitions and natural ignitions
```{r}
plot.list <- list()
sample.subset <- c(4, 5, 11, 32, 59, 1, 8, 16, 7, 24)
sample.subset.ig <- c(rep(1, 5), rep('M', 5))
for(i in sample.subset){
df <- temp.heat.flux.df %>% 
  filter(date == flam.df$date[i]) %>%  #index row, select column for date
  filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i])

title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])

plot <- ggplot(data = df, aes(x = time, y = temp)) +    
    geom_point(size = 0.6, aes(y = temp, color = thermo.id)) +
    geom_point(size = 1, alpha = 0.3, aes(y = heat.flux*100, color = sensor.id)) +
    scale_y_continuous(sec.axis = sec_axis(~.*.01, name="Heat Flux")) +
    # max flame height
    scale_color_manual(values = c('#02C3BD', '#00B9AE', '#009F93', '#037171',  '#03312E', 'black', '#D6A184', '#A63D40')) +
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + 
    annotate('text', label = 'M.FH', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) +
    annotate('text', label = 'M.Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'M. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 237, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature", color = " ", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  plot.list[[i]] <- plot
}
```

```{r}
# Natural ignitions (ignition = 1)
plot.list[[4]]
plot.list[[5]]
plot.list[[11]]
plot.list[[32]]
plot.list[[59]]

# Manual ignitions (ignition = M)
plot.list[[1]]
plot.list[[7]]
plot.list[[8]]
plot.list[[16]]
plot.list[[24]]
```

# Saving .csv
```{r}
write_csv(flam.df, here('data', 'processed-data', 'clean_flamm_data.csv'))
```
