---
title: "Thermocouple Temp. Data"
author: "Joe Celebrezze"
date: "2023-03-03"
output: html_document
---

Data cleaning prior to R: 
- Delete first rows of thermocoupler data

# Set-up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(hms)
library(caret) # for optimization routine

# defining functions
here = here::here

# reading in data
thermocoupler.files <- list.files(here('data', 'thermocouplers', 'raw-data'))
thermocoupler.df.list <- list()
for(i in 1:length(thermocoupler.files)){
  df <- read.csv(here('data', 'thermocouplers', 'raw-data', thermocoupler.files[[i]]))
  thermocoupler.df.list[[i]] <- df
}

flam.df <- read.csv(here('data', 'burn_samples_flamm.csv'))
```

# Data Wrangling
## Thermocoupler data
```{r}
# Combining thermocoupler datasheets
thermocoupler.df <- do.call('rbind', thermocoupler.df.list)

# Getting temperature data in correct format
for(i in 4:11){
thermocoupler.df[,i] <- thermocoupler.df[,i] %>% 
  str_replace(pattern = '\\+ ', replacement = ' ') %>% 
  str_trim(side = c('left'))
thermocoupler.df[,i] <- as.numeric(thermocoupler.df[,i])
}
thermocoupler.df <- na.omit(thermocoupler.df)

# Splitting date and time into two columns
thermocoupler.df <- thermocoupler.df %>% 
  mutate(Date.Time = as.POSIXct(Date.Time) + 80) %>%  # Adjusting time so it matches time on clock
  mutate(date = as.Date(Date.Time)) %>% 
  mutate(time = format(as.POSIXct(Date.Time), format = "%H:%M:%S")) %>% 
  mutate(time = as_hms(time))

# For heat flux
heatflux.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6, CH7, CH8)
heatflux.df.long <- heatflux.df %>% 
  select(date, time, ms, CH7, CH8) %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'sensor.id',
               values_to = 'heat.flux')

# Removing unncessary columns
thermocoupler.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6)

# Lengthening dataframe
thermocoupler.df.long <- thermocoupler.df %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'thermo.id',
               values_to = 'temp')

# Combining dataframes
temp.heat.flux.df <- merge(thermocoupler.df.long, heatflux.df.long, by = c('date', 'time', 'ms'))
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(sensor.location = case_when(
    sensor.id == 'CH7' ~ 'Top',
    sensor.id == 'CH8' ~ 'Left Side'
  ))
```

## Flamm data
Wrangling clocktime .csv, cleaning columns, etc.
```{r}
flam.df.clean <- flam.df %>% 
  mutate(start_time = start_time_clocktime) %>% 
  mutate(primary_ignition = firstigstart_time_clock_time) %>% 
  mutate(primary_time_of_flame_end = firstigend_time_clock_time) %>% 
  mutate(secondary_ignition = secondigstart_time_clock_time) %>% 
  mutate(secondary_time_of_flame_end = secondigend_time_clock_time) %>% 
  mutate(time_of_glow_end = end_time_clock_time) %>% 
  mutate(time_fh = maxflameht_time_clock_time) %>% 
  rename(fh = max_flame_height) %>% 
  select(-c(start_time_clocktime, firstigstart_time_clock_time, firstigend_time_clock_time, secondigstart_time_clock_time, secondigend_time_clock_time, end_time_clock_time, maxflameht_time_clock_time))

flam.df.clean <- replace(flam.df.clean, flam.df.clean=='', NA)

flam.df.clean <- flam.df.clean %>% 
  mutate(start_time = as_hms(format(as.POSIXct(start_time), format = "%H:%M:%S"))) %>% 
  mutate(primary_ignition = as_hms(format(as.POSIXct(primary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(primary_time_of_flame_end = as_hms(format(as.POSIXct(primary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(secondary_ignition = as_hms(format(as.POSIXct(secondary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(secondary_time_of_flame_end = as_hms(format(as.POSIXct(secondary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(time_of_glow_end = as_hms(format(as.POSIXct(time_of_glow_end), format = "%H:%M:%S"))) %>% 
  mutate(time_fh = as_hms(format(as.POSIXct(time_of_max_flame_height), format = "%H:%M:%S")))
```

```{r}
# Getting the time and date in the right format
flam.df <- flam.df.clean %>% 
  mutate(pre_ignition_glow = as.numeric(pre_ignition_glow)) %>% 
  mutate(fh = as.numeric(fh)) %>% 
  mutate(date = as.Date(date)) %>% 
  # FLAME DURATION
  mutate(fd = primary_time_of_flame_end - primary_ignition) %>% 
  mutate(fd = as.numeric(fd)) %>% 
  # TIME TO IGNITION
  mutate(tti = primary_ignition - start_time) %>% 
  mutate(tti = as.numeric(tti)) %>% 
  # POST FLAME GLOW
  mutate(pfg = time_of_glow_end - primary_time_of_flame_end) %>% 
  mutate(pfg = as.numeric(pfg))
```

Flam Data 2: dealing with some more complex data wrangling

Glow metrics
```{r}
# Glow duration, time to first glow, glow to ignition; for this, we need to get the first_glow_time in hms format; however, this was more challenging than expected. My proposed solution to deal with this problem is to split the dataframe in two -- one with N/A values and one with HH:MM:SS -- before using as_hms and calculating the above glow metrics
flam.df.na <- flam.df %>% 
  filter(pre_ignition_glow == 0) %>% 
  mutate(first_glow_time = NA) %>% 
  mutate(gd = NA) %>% 
  mutate(gti = NA) %>% 
  mutate(ttfg = NA)

flam.df.no.na <- flam.df %>% 
  filter(pre_ignition_glow == 1) %>% 
  mutate(first_glow_time = as_hms(first_glow_time)) %>% 
  mutate(gd = time_of_glow_end - first_glow_time) %>% 
  mutate(gti = primary_ignition - first_glow_time) %>% 
  mutate(ttfg = first_glow_time - start_time)

flam.df <- rbind(flam.df.na, flam.df.no.na)
```

# Calculating Max. Temp.
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_temp = NA) %>% 
  mutate(time_at_max_temp = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) #again, index row, select columns
  flam.df$max_temp[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp[i] <- df.mt$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp = as_hms(time_at_max_temp))
```

# Calculating Starting Temp.
(and temperature change)
```{r}
flam.df <- flam.df %>% 
  mutate(start_temp = NA)
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>% 
    filter(time == flam.df$start_time[i]) %>% 
    filter(ms == 0)
  flam.df$start_temp[i] <- max(df$temp)
}
flam.df <- flam.df %>% 
  mutate(temp_change = max_temp - start_temp)
```

# Calculating Max Heat Flux
## Option 1
Maximum heat flux value over the course of the test
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_heat_flux = NA) %>% 
  mutate(time_at_max_heat_flux = NA)
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(max_heat_flux = NA) 
for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns
  flam.df$max_heat_flux[i] <- max(df$heat.flux)
  df$max_heat_flux <- case_when(df$heat.flux == flam.df$max_heat_flux[i] ~ 'yes')
  df.mhf <- df %>% 
    filter(max_heat_flux == 'yes')
  flam.df$time_at_max_heat_flux[i] <- df.mhf$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_heat_flux = as_hms(time_at_max_heat_flux))
```

## Option 2
Using Loess smoothed regression and calculating maximum peak (for each sensor); leaning towards side sensor based on smaller signal-to-noise ratio

```{r}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_loessCH7 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH7 = NA) %>% 
  mutate(max_heat_flux_loessCH8 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = NA)
heatflux.df <- heatflux.df %>% 
  mutate(max_heat_flux_loessCH7 = NA)  %>% 
  mutate(max_heat_flux_loessCH8 = NA)
# NOTE: THIS PART WILL NOT BE NECESSARY WHEN ALL DATALOGGER DATA IS INPUTTED
flam.df.no.Inf <- flam.df %>% 
  filter(max_heat_flux > 0)
flam.df.Inf <- flam.df %>% 
  filter(max_heat_flux < 0) 

for(i in 1:nrow(flam.df.no.Inf)){
  df <- heatflux.df %>% 
    filter(date == flam.df.no.Inf$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.no.Inf$start_time[i] & time <= flam.df.no.Inf$time_of_glow_end[i]) %>% #again, index row, select columns
    mutate(time = as.numeric(time))
  
# Loess regressions
  loess.mod.CH7 <- loess(CH7 ~ time, data = df, span = 0.3)
  df$loess.CH7 <- predict(loess.mod.CH7)
  loess.mod.CH8 <- loess(CH8 ~ time, data = df, span = 0.3)
  df$loess.CH8 <- predict(loess.mod.CH8)

  flam.df.no.Inf$max_heat_flux_loessCH7[i] <- max(df$loess.CH7)
  flam.df.no.Inf$max_heat_flux_loessCH8[i] <- max(df$loess.CH8)
  
  df$max_heat_flux_loessCH7 <- case_when(df$loess.CH7 == flam.df.no.Inf$max_heat_flux_loessCH7[i] ~ 'yes')
  df$max_heat_flux_loessCH8 <- case_when(df$loess.CH8 == flam.df.no.Inf$max_heat_flux_loessCH8[i] ~ 'yes')
  
  df.mhf_CH7 <- df %>% 
    filter(max_heat_flux_loessCH7 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH7[i] <- df.mhf_CH7$time[1]
  df.mhf_CH8 <- df %>% 
    filter(max_heat_flux_loessCH8 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH8[i] <- df.mhf_CH8$time[1]
}
flam.df.no.Inf <- flam.df.no.Inf %>% 
  mutate(time_at_max_heat_flux_loessCH7 = as_hms(time_at_max_heat_flux_loessCH7)) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = as_hms(time_at_max_heat_flux_loessCH8))

flam.df <- rbind(flam.df.no.Inf, flam.df.Inf)
```

```{r}
heatflux.df.woop <- heatflux.df %>% 
  filter(date == flam.df.no.Inf$date[40]) %>%  #index row, select column for date
  filter(time >= flam.df.no.Inf$start_time[40] & time <= flam.df.no.Inf$time_of_glow_end[40]) %>% 
  mutate(time = as.numeric(time))

loess.mod.CH7 <- loess(CH7 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0691)
heatflux.df.woop$loess.CH7 <- predict(loess.mod.CH7)

ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH7), color = 'black') +
  geom_point(aes(y = CH7), color = 'blue', alpha = 0.2) +
  labs(x = 'Time', y = 'Heat Flux (Side Sensor)') +
  theme_bw() + 
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))

loess.mod.CH8 <- loess(CH8 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0337)
heatflux.df.woop$loess.CH8 <- predict(loess.mod.CH8)

ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH8), color = 'black') +
  geom_point(aes(y = CH8), color = 'blue', alpha = 0.2) +
  labs(x = 'Time', y = 'Heat Flux (Top Sensor)') +
  theme_bw() +  
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))
```

## Optimizing Smoothing Span
```{r, warning = F}
flam.df.sample <- sample_n(flam.df.no.Inf, 50)

CH7results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))
colnames(CH7results) <- colnames(best)

CH8results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))
colnames(CH8results) <- colnames(best)

ctrl <- trainControl(method = "cv", number = 5)
grid <- expand.grid(span = seq(0.01, 0.5, len = 50), degree = 1)

for(i in 1:length(flam.df.sample)){
  df <- heatflux.df %>% 
    filter(date == flam.df.sample$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.sample$start_time[i] & time <= flam.df.sample$time_of_glow_end[i]) %>% 
    mutate(time = as.numeric(time))
  
  CH7model <- train(CH7 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)
  
  CH8model <- train(CH8 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)

  ch7.res <- as.data.frame(CH7model$results)
  ch7.best <- ch7.res[which.min(ch7.res$RMSE),]
  CH7results[i,] <- ch7.best
  
  ch8.res <- as.data.frame(CH8model$results)
  ch8.best <- ch8.res[which.min(ch8.res$RMSE),]
  CH8results[i,] <- ch8.best
}

CH7results <- na.omit(CH7results)
mean(CH7results$span) # 0.0691

CH8results <- na.omit(CH8results)
mean(CH8results$span) # 0.0337
```

# Average Heat Flux of Flame Duration
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH7') %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
```


# Visualization
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('thermocoupler_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = temp, color = thermo.id)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

Plots
```{r}
plot.list[[5]]
plot.list[[10]]
plot.list[[15]]
plot.list[[20]]
plot.list[[26]]
plot.list[[30]]
plot.list[[36]]
plot.list[[40]]
plot.list[[45]]
plot.list[[55]]
```

HETARB shows very low temperatures for 4/6 thermocouples. What is going on?
```{r}
thermocoupler.df.long %>% 
    ggplot(aes(x = time, y = temp, color = thermo.id)) +
      geom_point(size = 0.4) +
      theme_bw() +
      labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID",
           title = "Differences Between Dates") +
      facet_wrap(~date, ncol = 1) +
      theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
```

# Heat Flux
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('heatflux_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])
  
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = heat.flux, color = sensor.location)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 1.4, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 1.3, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'Max. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 1.5, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Heat Flux", color = "Sensor Location", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

Plots
```{r}
plot.list[[1]]
plot.list[[4]]
plot.list[[7]]
plot.list[[16]]
plot.list[[20]]
plot.list[[47]]
plot.list[[69]]
plot.list[[71]]
plot.list[[73]]
plot.list[[99]]
```

# Temp and Heat Flux
Investigating differences between manual ignitions and natural ignitions
```{r}
plot.list <- list()
sample.subset <- c(4, 5, 11, 32, 59, 1, 8, 16, 7, 24)
sample.subset.ig <- c(rep(1, 5), rep('M', 5))
for(i in sample.subset){
df <- temp.heat.flux.df %>% 
  filter(date == flam.df$date[i]) %>%  #index row, select column for date
  filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i])

title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])

plot <- ggplot(data = df, aes(x = time, y = temp)) +    
    geom_point(size = 0.6, aes(y = temp, color = thermo.id)) +
    geom_point(size = 1, alpha = 0.3, aes(y = heat.flux*100, color = sensor.id)) +
    scale_y_continuous(sec.axis = sec_axis(~.*.01, name="Heat Flux")) +
    # max flame height
    scale_color_manual(values = c('#02C3BD', '#00B9AE', '#009F93', '#037171',  '#03312E', 'black', '#D6A184', '#A63D40')) +
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + 
    annotate('text', label = 'M.FH', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) +
    annotate('text', label = 'M.Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'M. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 237, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature", color = " ", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  plot.list[[i]] <- plot
}
```

```{r}
# Natural ignitions (ignition = 1)
plot.list[[4]]
plot.list[[5]]
plot.list[[11]]
plot.list[[32]]
plot.list[[59]]

# Manual ignitions (ignition = M)
plot.list[[1]]
plot.list[[7]]
plot.list[[8]]
plot.list[[16]]
plot.list[[24]]
```

# Saving .csv
```{r}
write_csv(flam.df, here('data', 'processed-data', 'clean_flamm_data.csv'))
```
