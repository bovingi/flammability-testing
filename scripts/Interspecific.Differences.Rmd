---
title: "Species Differences: Looking at Species-Specific Variables, Average Values
  for Species"
author: "Joe Celebrezze"
date: "2023-07-17"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(multcompView) # to display Tukey-Kramer results
library(factoextra) #for k-means clustering
library(lme4) # for MEM
library(emmeans) # for tukey-kramer tests (w/ random effects)
library(ggpubr)

here = here::here
alpha = scales::alpha

# reading in data
flamm.df <- read.csv(here('data', 'processed-data', 'main_dataset.csv')) %>% 
  unite('plant_id', c(species, plant), sep = '_', remove = F) # adding plant_id for random effects
```

Although the mixed effects model selection tells us a lot about our data and provides useful insights, it doesn't include all of the variables and it leaves some of our question unanswered:

*Question*: How can interspecific differences in flammability be described by plant traits -- plant hydration, plant morphology, leaf traits, VOC's?

With the mixed effects models, we looked into which variables were key in predicting the flammability metrics, but we did not necessarily look into how the above question fully. To do so, let's look at interspecific differences in flammability metrics and then interspecific differences in traits of interest and compare them.

We are also going to do the k-means cluster analysis here on a full dataset, a dataset with flammability metrics, and a dataset with traits to try and get at the question above

# Boxplots, ANOVAs

## Flammability Metrics

### Flame Height
```{r}
fh.spp <- lmer(fh ~ species + (1|plant_id), data = flamm.df)
anova(fh.spp)
fh.spp.tukey <- emmeans(fh.spp, pairwise ~ species, adjust = 'tukey')
fh.spp.tukey.df <- summary(fh.spp.tukey$contrasts)
fh.spp.tukey.labels <- data.frame(species = c('HETARB', 'CEAGRI', 'SALAPI', 'MALLAU', 'MANDEN', 'SALLEU', 'ARTCAL', 'IRIDOU', 'ERIKAR'), letters = c('a', 'ab', 'ab', 'ab', 'abc', 'bc', 'bc', 'c', 'c'), adj = c(0, 0, 4, 4, 4, 0, 0, 4, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

fh.boxplot <- flamm.df %>%
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot(aes(x = species, y = fh)) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 65 + adj, label = letters), fontface = 'bold',
              data = fh.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Flame Height (cm)') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
fh.boxplot
```

### Flame Duration
```{r}
fd.spp <- lmer(fd ~ species + (1|plant_id), data = flamm.df)
anova(fd.spp)
fd.spp.tukey <- emmeans(fd.spp, pairwise ~ species, adjust = 'tukey')
fd.spp.tukey.df <- summary(fd.spp.tukey$contrasts)
fd.spp.tukey.labels <- data.frame(species = c('CEAGRI', 'MALLAU', 'HETARB', 'SALLEU', 'MANDEN', 'SALAPI', 'IRIDOU', 'ARTCAL', 'ERIKAR'), letters = c('a', 'a', 'ab', 'abc', 'abcd', 'bcd', 'cd', 'cd', 'd'), adj = c(0, 4, 0, 0, 4, 4, 4, 0, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

fd.boxplot <- flamm.df %>%
  filter(fd < 70) %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = fd), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = fd), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 59.5 + adj, label = letters), fontface = 'bold',
              data = fd.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Flame Duration (sec)') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
fd.boxplot
```

### Temp. Change
```{r}
tc.spp <- lmer(temp_change ~ species + (1|plant_id), data = flamm.df)
anova(tc.spp)
tc.spp.tukey <- emmeans(tc.spp, pairwise ~ species, adjust = 'tukey')
tc.spp.tukey.df <- summary(tc.spp.tukey$contrasts)
tc.spp.tukey.labels <- data.frame(species = c('HETARB', 'MALLAU', 'SALLEU', 'SALAPI', 'CEAGRI', 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'), letters = c('a', 'ab', 'ab', 'ab', 'ab', 'ab', 'b', 'b', 'b'),
                                  adj = c(0, 3, 0, 3, 0, 3, 0, 3, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

tc.boxplot <- flamm.df %>%
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  filter(temp_change < 100) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = temp_change), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = temp_change), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 38 + adj, label = letters), fontface = 'bold',
              data = tc.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Temp. Change') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
tc.boxplot
```

### Heat Flux Change
```{r}
hf.spp <- lmer(heat_flux_change ~ species + (1|plant_id), data = flamm.df)
anova(hf.spp)
hf.spp.tukey <- emmeans(hf.spp, pairwise ~ species, adjust = 'tukey')
hf.spp.tukey.df <- summary(hf.spp.tukey$contrasts)
hf.spp.tukey.labels <- data.frame(species = c('HETARB', 'SALAPI', 'MALLAU', 'CEAGRI', 'SALLEU', 'MANDEN', 'IRIDOU', 'ARTCAL', 'ERIKAR'), letters = c('a', 'ab', 'abc', 'abc', 'bc', 'bc', 'bc', 'bc', 'c'), adj = c(0, 0.015, 0.015, 0, 0, 0.015, 0.015, 0, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

hf.boxplot <- flamm.df %>%
  filter(heat_flux_change < 0.3) %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = heat_flux_change), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = heat_flux_change), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 0.217 + adj, label = letters), fontface = 'bold',
              data = hf.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Heat Flux Change') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
hf.boxplot
```

## Traits

### Sample Weight
Because all of the 'sample size' metrics are pretty similar, I think looking at only one, at least for now will work. Wet weight has been instrumental in previous analyses, so we will use it below
```{r}
sw.spp <- lmer(sample_wt ~ species + (1|plant_id), data = flamm.df)
anova(sw.spp)
sw.spp.tukey <- emmeans(sw.spp, pairwise ~ species, adjust = 'tukey')
sw.spp.tukey.df <- summary(sw.spp.tukey$contrasts)
sw.spp.tukey.labels <- data.frame(species = c('HETARB', 'MALLAU', 'SALAPI', 'CEAGRI', 'SALLEU', 'MANDEN', 'IRIDOU', 'ARTCAL', 'ERIKAR'), letters = c('a', 'a', 'b', 'bc', 'c', 'c', 'c', 'c', 'c'), 
                                  adj = c(0, 1.7, 1.7, 0, 0, 1.7, 1.7, 0, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

sw.boxplot <- flamm.df %>%
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = sample_wt), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = sample_wt), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 24.6 + adj, label = letters), fontface = 'bold',
              data = sw.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Sample Weight (g)') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
sw.boxplot
```

### MPa
```{r}
mpa.spp <- lmer(mpa ~ species + (1|plant_id), data = flamm.df)
anova(mpa.spp)
mpa.spp.tukey <- emmeans(mpa.spp, pairwise ~ species, adjust = 'tukey')
mpa.spp.tukey.df <- summary(mpa.spp.tukey$contrasts)
mpa.spp.tukey.labels <- data.frame(species = c('CEAGRI', 'ARTCAL', 'ERIKAR', 'HETARB', 'MALLAU', 'SALLEU', 'MANDEN', 'SALAPI', 'IRIDOU'), letters = c('a', 'b', 'bc', 'bc', 'bc', 'bcd', 'bcd', 'cd', 'd'), adj = c(0, 0, 0, 0, 0.025, 0, 0.025, 0.025, 0.025)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

mpa.boxplot <- flamm.df %>%
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = mpa), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = mpa), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 0.41 + adj, label = letters), fontface = 'bold',
              data = mpa.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Water Potential (-MPa)') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
mpa.boxplot
```

### Branching
```{r}
branching.spp <- lmer(branching ~ species + (1|plant_id), data = flamm.df)
anova(branching.spp)
branching.spp.tukey <- emmeans(branching.spp, pairwise ~ species, adjust = 'tukey')
branching.spp.tukey.df <- summary(branching.spp.tukey$contrasts)
branching.spp.tukey.labels <- data.frame(species = c('CEAGRI', 'MANDEN', 'SALLEU', 'ARTCAL', 'MALLAU', 'HETARB', 'ERIKAR', 'SALAPI', 'IRIDOU'), letters = c('a', 'ab', 'ab', 'ab', 'bc', 'bc', 'c', 'c', 'c'),
                                         adj = c(0, 0.035, 0, 0, 0.035, 0, 0, 0.035, 0.035)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)

branching.boxplot <- flamm.df %>%
  filter(branching < 0.75) %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = branching), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = branching), width = 0.2, alpha = 0.2) +
    geom_text(aes(x = species, y = 0.65 + adj, label = letters), fontface = 'bold',
              data = branching.spp.tukey.labels, size = 6) +
    labs(x = 'Species', y = 'Branching') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
branching.boxplot
```

### Starting Temp
```{r}
st.spp <- lmer(start_temp ~ species + (1|plant_id), data = flamm.df)
anova(st.spp)
st.spp.tukey <- emmeans(st.spp, pairwise ~ species, adjust = 'tukey')
st.spp.tukey.df <- summary(st.spp.tukey$contrasts)
st.spp.tukey.labels <- data.frame(species = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                              'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'),
                                  letters = c('b', 'b', 'ab', 'b', 'b', 'ab', 'a', 'b', 'ab'),
                                  adj = c(0, 6, 0, 6, 0, 6, 0, 6, 0)) # manually extracted from above dataframe (couldn't figure out way to automate process w/ emmeans)


flamm.df %>%
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot() +
    geom_boxplot(aes(x = species, y = start_temp), outlier.shape = NA, alpha= 0.8) +
    geom_jitter(aes(x = species, y = start_temp), width = 0.2, alpha = 0.2) +
    labs(x = 'Species', y = 'Start Temp.') +
    geom_text(aes(x = species, y = 240 + adj, label = letters), fontface = 'bold',
              data = st.spp.tukey.labels, size = 6) +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 18),
          axis.text.x = element_text(size = 13, angle = 20),
          axis.text.y = element_text(size = 15))
```

### Avg. VOC Emissions
```{r}
flamm.df %>%
  filter(species != 'MANDEN') %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI',
                                        'SALLEU', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  dplyr::group_by(species) %>% 
  dplyr::summarise(avg_voc = mean(avg_voc)) %>% 
  ggplot() +
    geom_point(aes(x = species, y = log(avg_voc), color = species), size = 7, alpha = 0.7) +
    labs(x = 'Species', y = 'Avg. VOCs (log-transformed)') +
  scale_color_manual(values = c("#98897A", "#91C499", "#3C5233", "#B6DFF9", '#FF3A20', "#271F30",
                                         "#BB9FED", "#CFD11A")) +
    theme_bw() +
    theme(legend.position = 'none', 
          axis.title = element_text(face = 'bold', size = 17),
          axis.text.x = element_text(size = 13, angle = 10),
          axis.text.y = element_text(size = 15))
ggsave(here('figures', 'spp.voc.png'), height = 5, width = 9)
```

## Arranging
```{r}
ggarrange(fh.boxplot, fd.boxplot, hf.boxplot, sw.boxplot, branching.boxplot, mpa.boxplot,
          labels = c('A', 'B', 'C', 'D', 'E', 'F'),
          font.label = list(size = 28),
          ncol = 3, nrow = 2)

ggsave(here('figures', 'main_figures', 'spp.boxplots.png'), height = 9, width = 13.5)
```


# K-means Clustering
## Flamm Metrics
NOTE: Ignition method has significant effect on clustering
```{r}
id <- c(1:nrow(flamm.df))
flamm.df <- cbind(flamm.df, id) %>% 
  unite('species_id', c(species, id), remove = F)

# so it's replicable
set.seed(16)

# labels
flam_labels <- c('Flame Height', 'Flame Duration', 'Temperature Change', 'Heat Flux Change', '% Ignited')
names(flam_labels) <- c('fh', 'fd', 'temp_change', 'heat_flux_change', 'prop_ig')

# prepping dataset
flamm_kmeans_df <- flamm.df %>% 
  filter(ignition != 0) %>% 
  select(species_id, species, ignition, fh, fd, temp_change, heat_flux_change) %>% 
  na.omit()

rownames(flamm_kmeans_df) <- flamm_kmeans_df$species_id

flamm_kmeans_scaled_df <- flamm_kmeans_df %>% 
  select(-c(species_id, species, ignition)) %>%
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "wss") #k = 2 or k = 3
# 2. silhouette method
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "silhouette") #k = 2

# run k-means clustering
#perform k-means clustering with k = 2 clusters
km <- kmeans(flamm_kmeans_scaled_df, centers = 2)
#plot results of final k-means model
fviz_cluster(km, data = flamm_kmeans_scaled_df)
#add cluster assigment to original data
flamm_kmeans_df <- cbind(flamm_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
flamm_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(flamm_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #', title = 'K-Means Clustering: Flam. Metrics')

flamm_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count', title = 'K-Means Clustering: Flam. Metrics')

flamm_kmeans_df %>% 
  pivot_longer(cols = c(fd, fh, heat_flux_change, temp_change), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(cluster), y = val, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    facet_wrap(~var, scales = 'free', labeller = labeller(var = flam_labels)) +
    labs(x = 'K-Means Cluster', y = 'Flamm. Metric Value') +
    scale_color_manual(values = c('goldenrod4', 'gold3')) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 17),
          axis.text = element_text(size = 15),
          strip.text = element_text(face = 'bold', size = 15))

flamm_kmeans_df %>% 
  group_by(cluster, species) %>% 
  tally() %>%  
  pivot_wider(names_from = cluster, values_from = n) %>% 
  mutate(`1` = ifelse(is.na(`1`), 0, `1`),
         `2` = ifelse(is.na(`2`), 0, `2`)) %>% 
  mutate(kmeans.flam.index = (`2`)/(`2` + `1`)) %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                   'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot(aes(x = species, y = kmeans.flam.index, color = species)) +
    geom_point(size = 7) +
    labs(x = 'Species', y = 'K-Means Clustering: Combustibility Index') +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 14),
          axis.text = element_text(size = 13),
          axis.text.x = element_text(angle = 15))

flamm_kmeans_df %>% 
  group_by(ignition, cluster) %>% 
  tally()

ignition.vs.cluster <- lm(cluster ~ ignition, data = flamm_kmeans_df)
anova(ignition.vs.cluster)
summary(ignition.vs.cluster)
```

## Leaf Traits
```{r}
# labels
traits_labels <- c('Live Fuel Moisture (%)', 'Water Potential (-MPa)', 'Sample Weight (g)', 'Leaf Mass per Area', 'Leaf Thickness (mm)', 'Branching', 'Leaf Mass Ratio', 'Sample Density (g/cm3)', 'Sample Volume (cm3)')
names(traits_labels) <- c('lfm', 'mpa', 'sample_wt', 'LMA', 'thickness', 'branching', 'leaf_mass_ratio', 'sample_density', 'branch_volume')

# prepping dataset
traits_kmeans_df <- flamm.df %>% 
  filter(ignition != 0) %>% 
  select(species, species_id, ignition, lfm, mpa, sample_wt, LMA, thickness, branching, leaf_mass_ratio, sample_density, branch_volume) %>% 
  na.omit()

rownames(traits_kmeans_df) <- traits_kmeans_df$species_id

traits_kmeans_scaled_df <- traits_kmeans_df %>% 
  select(-c(species_id, species, ignition)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "wss") #k = 3 or 4
# 2. silhouette method
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "silhouette") #k = 4, 6, 8 or 10

# run k-means clustering
#perform k-means clustering with k = 3 clusters
km <- kmeans(traits_kmeans_scaled_df, centers = 3)
#plot results of final k-means model
fviz_cluster(km, data = traits_kmeans_scaled_df)
#add cluster assigment to original data
traits_kmeans_df <- cbind(traits_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
traits_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(traits_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #', title = 'K-Means Clustering: Plant Traits')

traits_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count', title = 'K-Means Clustering: Plant Traits')

traits_kmeans_df %>% 
  pivot_longer(cols = c(lfm, mpa, sample_density, LMA, thickness, branching, leaf_mass_ratio, sample_wt, branch_volume), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(cluster), y = val, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    facet_wrap(~var, scales = 'free', labeller = labeller(var = traits_labels)) +
    labs(x = 'K-Means Cluster', y = 'Traits Value') +
    scale_color_manual(values = c('goldenrod4', 'gold3', 'firebrick')) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 17),
          axis.text = element_text(size = 15),
          strip.text = element_text(face = 'bold', size = 15))
```

## Traits and Flammability
```{r}
# labels
kmeans_labels <- c('Flame Height', 'Flame Duration', 'Temperature Change', 'Heat Flux Change', 'Live Fuel Moisture (%)', 'Water Potential (-MPa)', 'Sample Weight (g)', 'Leaf Mass per Area', 'Branching', 'Sample Density (g/cm3)')
names(kmeans_labels) <- c('fh', 'fd', 'temp_change', 'heat_flux_change', 'lfm', 'mpa', 'sample_wt', 'LMA', 'branching', 'sample_density')

# prepping dataset
kmeans_df <- flamm.df %>% 
  filter(ignition != 0) %>% 
  select(species, species_id, ignition, fh, fd, temp_change, heat_flux_change, lfm, mpa, sample_wt, LMA, branching, sample_density, plant_id) %>% 
  na.omit()

rownames(kmeans_df) <- kmeans_df$species_id

kmeans_scaled_df <- kmeans_df %>% 
  select(-c(species_id, species, ignition, plant_id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(kmeans_scaled_df, kmeans, method = "wss") #k = 2 or 3
# 2. silhouette method
fviz_nbclust(kmeans_scaled_df, kmeans, method = "silhouette") #k = 2

# run k-means clustering
#perform k-means clustering with k = 3 clusters
km <- kmeans(kmeans_scaled_df, centers = 2)

#plot results of final k-means model
fviz_cluster(km, data = kmeans_scaled_df) +
  scale_color_manual(values = c('goldenrod4', 'gold3')) +
  scale_fill_manual(values = c(alpha('goldenrod4', 0.5), alpha('gold3', 0.5))) +
  theme_bw() +
  labs(color = 'K-Means Cluster', shape = 'K-Means Cluster', fill = 'K-Means Cluster') +
  theme(plot.title = element_blank(),
        legend.title = element_text(face = 'bold', size = 18),
        legend.text = element_text(size = 16),
        legend.position = c(0.15, 0.15),
        axis.title = element_text(face = 'bold', size = 17),
        axis.text = element_text(size = 15))
ggsave(here('figures', 'main_figures', 'traits.flam.k.means.cluster.png'), width = 10, height = 7)

#add cluster assigment to original data
kmeans_df <- cbind(kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
kmeans_df %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(traits_kmeans_df$cluster))) +
    labs(x = 'Species', y = 'K-Means Cluster', color = 'Cluster #') +
    theme_bw() +
    scale_color_manual(values = c('goldenrod4', 'gold3')) +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 18),
          axis.text.y = element_text(size = 16), 
          axis.text.x = element_text(size = 14, angle = 20))
ggsave(here('figures', 'main_figures', 'spp.vs.k.means.cluster.png'), height = 4.5, width = 9)

kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count', title = 'K-Means Clustering')

plot.labels.df <- data.frame(var = c('branching', 'fd', 'fh', 'heat_flux_change', 'lfm', 'LMA', 'mpa', 'sample_density', 'sample_wt', 'temp_change'), label = c('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'))

#val = c(0.5, 95, 65, 0.23, 375, 0.265, 0.42, 0.235, 23.5, 38), cluster = c(rep(1, 10)),

kmeans_df %>% 
  filter(heat_flux_change < 0.3, sample_density < 0.4, temp_change < 50) %>% 
  pivot_longer(cols = c(fh, fd, temp_change, heat_flux_change, lfm, mpa, sample_wt, LMA, branching, sample_density), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(cluster), y = val, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    facet_wrap(~var, scales = 'free', labeller = labeller(var = kmeans_labels), ncol = 5) +
    geom_text(data = plot.labels.df, mapping = aes(x = -Inf, y = -Inf, label = label),
              color = 'black', hjust = -0.9, vjust = -11.2, size = 10, fontface = 'bold') +
    labs(x = 'K-Means Cluster') +
    scale_color_manual(values = c('goldenrod4', 'gold3')) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.x = element_text(face = 'bold', size = 17),
          axis.title.y = element_blank(),
          axis.text = element_text(size = 15),
          strip.text = element_text(face = 'bold', size = 15))
ggsave(here('figures', 'main_figures', 'traits.flam.k.means.boxplot.png'), width = 17, height = 9)

t.test(branching ~ cluster, data = kmeans_df) # sig. difference
t.test(lfm ~ cluster, data = kmeans_df) # sig. difference
t.test(mpa ~ cluster, data = kmeans_df) # sig. difference
t.test(LMA ~ cluster, data = kmeans_df) # sig. difference
t.test(sample_wt ~ cluster, data = kmeans_df) # sig. difference
t.test(sample_density ~ cluster, data = kmeans_df) # sig. difference
t.test(fh ~ cluster, data = kmeans_df) # sig. difference
t.test(fd ~ cluster, data = kmeans_df) # sig. difference
t.test(temp_change ~ cluster, data = kmeans_df) # sig. difference
t.test(heat_flux_change ~ cluster, data = kmeans_df) # sig. difference
```

### Intermediates Between Clusters
From above cluster plot, choosing samples that are in the 'intermediate space' between clusters (i.e., that area on the inner margins between the two clusters)
```{r}
kmeans_df <- kmeans_df %>% 
  mutate(int_cluster = ifelse(species_id %in% c('SALAPI_217', 'SALAPI_215', 'SALAPI_214', 'SALAPI_201', 'SALAPI_212', 'SALAPI_199', 'SALAPI_197', 'SALLEU_230', 'SALLEU_252', 'SALLEU_245', 'SALLEU_219', 'SALLEU_225', 'SALLEU_224', 'SALLEU_223', 'SALLEU_253', 'SALLEU_256', 'SALLEU_232', 'SALLEU_251', 'SALLEU_246', 'SALLEU_247', 'SALLEU_231', 'MALLAU_185', 'MALLAU_171', 'MALLAU_169', 'MALLAU_168', 'MALLAU_183', 'MALLAU_172', 'MALLAU_175', 'MALLAU_182', 'CEAGRI_86', 'CEAGRI_78', 'CEAGRI_72', 'MANDEN_187', 'MANDEN_188', 'MANDEN_189', 'MANDEN_190', 'MANDEN_192', 'MANDEN_193', 'MANDEN_195', 'HETARB_138', 'HETARB_136'), 1.5, cluster)
  )

# species differences
kmeans_df %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot(aes(x = species, y = int_cluster, color = as.factor(int_cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:3)) +
    labs(x = 'Species', y = 'K-Means Cluster', color = 'Cluster #') +
    theme_bw() +
    scale_color_manual(values = c('goldenrod4', 'black', 'gold3')) +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 18),
          axis.text.y = element_text(size = 16), 
          axis.text.x = element_text(size = 14, angle = 20))

kmeans_df %>% 
  filter(heat_flux_change < 0.3, sample_density < 0.4, temp_change < 50) %>% 
  pivot_longer(cols = c(fh, fd, temp_change, heat_flux_change, lfm, mpa, sample_wt, LMA, branching, sample_density), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(int_cluster), y = val, color = as.factor(int_cluster))) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    facet_wrap(~var, scales = 'free', labeller = labeller(var = kmeans_labels), ncol = 5) +
    geom_text(data = plot.labels.df, mapping = aes(x = -Inf, y = -Inf, label = label),
              color = 'black', hjust = -0.9, vjust = -11.2, size = 10, fontface = 'bold') +
    labs(x = 'K-Means Cluster') +
    scale_color_manual(values = c('goldenrod4', 'black', 'gold3')) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.x = element_text(face = 'bold', size = 17),
          axis.title.y = element_blank(),
          axis.text = element_text(size = 15),
          strip.text = element_text(face = 'bold', size = 15))
```

## Traits and Flammability #2
```{r}
flamm.df %>% 
  ggplot(aes(x = branch_volume, y = sample_density)) +
    geom_point() +
    theme_bw()

flamm.df %>% 
  ggplot(aes(x = sample_wt, y = sample_density)) +
    geom_point() +
    theme_bw()

woohoo <- flamm.df %>% 
  select(species, sample_wt, branch_volume, sample_density, branch_length, branch_height, branch_width)
```


```{r}
set.seed(2)
# labels
kmeans_labels <- c('Flame Height', 'Flame Duration', 'Heat Flux Change', 'Live Fuel Moisture (%)', 'Water Potential (-MPa)', 'Sample Weight (g)', 'Leaf Mass Ratio', 'Branching')
names(kmeans_labels) <- c('fh', 'fd', 'heat_flux_change', 'lfm', 'mpa', 'sample_wt', 'leaf_mass_ratio', 'branching')

# prepping dataset
kmeans_df2 <- flamm.df %>% 
  filter(ignition != 0) %>% 
  select(species, species_id, ignition, fh, fd, heat_flux_change, lfm, mpa, sample_wt, leaf_mass_ratio, branching, plant_id) %>% 
  na.omit()

rownames(kmeans_df2) <- kmeans_df2$species_id

kmeans_scaled_df2 <- kmeans_df2 %>% 
  select(-c(species_id, species, ignition, plant_id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(kmeans_scaled_df2, kmeans, method = "wss") #k = 3 or 4
# 2. silhouette method
fviz_nbclust(kmeans_scaled_df2, kmeans, method = "silhouette") #k = 2

# run k-means clustering
#perform k-means clustering with k = 2 clusters
km <- kmeans(kmeans_scaled_df2, centers = 3)
km$cluster <- case_when(km$cluster == 1 ~ 1,
                         km$cluster == 2 ~ 3,
                         km$cluster == 3 ~ 2)

#plot results of final k-means model
fviz_cluster(km, data = kmeans_scaled_df2) +
  scale_color_manual(values = c('goldenrod4', 'gray40', 'gold3')) +
  scale_fill_manual(values = c(alpha('goldenrod4', 0.5), alpha('gray40', 0.5), alpha('gold3', 0.5))) +
  theme_bw() +
  labs(color = 'K-Means Cluster', shape = 'K-Means Cluster', fill = 'K-Means Cluster') +
  theme(plot.title = element_blank(),
        legend.title = element_text(face = 'bold', size = 18),
        legend.text = element_text(size = 16),
        legend.position = c(0.15, 0.15),
        axis.title = element_text(face = 'bold', size = 17),
        axis.text = element_text(size = 15))
ggsave(here('figures', 'main_figures', 'traits.flam.k.means.cluster.no2.png'), width = 10, height = 7)

#add cluster assigment to original data
kmeans_df2 <- cbind(kmeans_df2, cluster = km$cluster)

#visualizing how cluster assignment tracks species
kmeans_df2 %>% 
  mutate(species = fct_relevel(species, levels = c('HETARB', 'MALLAU', 'CEAGRI', 'SALAPI', 'SALLEU',
                                                 'MANDEN', 'ARTCAL', 'IRIDOU', 'ERIKAR'))) %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(traits_kmeans_df$cluster))) +
    labs(x = 'Species', y = 'K-Means Cluster', color = 'Cluster #') +
    theme_bw() +
    scale_color_manual(values = c('goldenrod4', 'gray40', 'gold3')) +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 18),
          axis.text.y = element_text(size = 16), 
          axis.text.x = element_text(size = 14, angle = 20))
ggsave(here('figures', 'main_figures', 'spp.vs.k.means.cluster.no2.png'), height = 4.5, width = 9)

plot.labels.df <- data.frame(var = c('branching', 'fd', 'fh', 'heat_flux_change', 'leaf_mass_ratio', 'lfm', 'mpa', 'sample_wt'), label = c('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'))

kmeans_df2 %>% 
  filter(heat_flux_change < 0.3) %>% 
  pivot_longer(cols = c(fh, fd, heat_flux_change, lfm, mpa, sample_wt, leaf_mass_ratio, branching), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(cluster), y = val, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA, alpha= 0.8) +
    geom_jitter(width = 0.2, alpha = 0.2) +
    facet_wrap(~var, scales = 'free', labeller = labeller(var = kmeans_labels), ncol = 4) +
    geom_text(data = plot.labels.df, mapping = aes(x = -Inf, y = -Inf, label = label),
              color = 'black', hjust = -0.9, vjust = -11.2, size = 10, fontface = 'bold') +
    labs(x = 'K-Means Cluster') +
    scale_color_manual(values = c('goldenrod4', 'gray40', 'gold3')) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.x = element_text(face = 'bold', size = 17),
          axis.title.y = element_blank(),
          axis.text = element_text(size = 15),
          strip.text = element_text(face = 'bold', size = 15))
ggsave(here('figures', 'main_figures', 'traits.flam.k.means.boxplot.no2.png'), width = 17, height = 9)
```
