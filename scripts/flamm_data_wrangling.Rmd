---
title: 'Data Wrangling: Flammability'
author: "Joe Celebrezze"
date: "2023-04-14"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(ggfortify)
library(hms)

# defining functions
here = here::here

# reading in data
thermocoupler.files <- list.files(here('data', 'raw-data', 'thermocouplers'))
thermocoupler.df.list <- list()
for(i in 1:length(thermocoupler.files)){
  df <- read.csv(here('data', 'raw-data', 'thermocouplers', thermocoupler.files[[i]]))
  thermocoupler.df.list[[i]] <- df
}

flam.df <- read.csv(here('data', 'raw-data', 'flamm', 'burn_samples_flamm.csv'))
```

# Data Wrangling
## Datalogger Data
This includes data from the thermocouplers (CH1-6) as well as the heat flux sensors (CH7-8); the datalogger took data every 500 ms
```{r}
# Combining thermocoupler datasheets
thermocoupler.df <- do.call('rbind', thermocoupler.df.list)

# Getting temperature data in correct format
for(i in 4:11){
thermocoupler.df[,i] <- thermocoupler.df[,i] %>% 
  str_replace(pattern = '\\+ ', replacement = ' ') %>% 
  str_trim(side = c('left'))
thermocoupler.df[,i] <- as.numeric(thermocoupler.df[,i])
}
thermocoupler.df <- na.omit(thermocoupler.df)

# Splitting date and time into two columns
thermocoupler.df <- thermocoupler.df %>% 
  mutate(Date.Time = as.POSIXct(Date.Time) + 80) %>%  # Adjusting time so it matches time on clock
  mutate(date = as.Date(Date.Time)) %>% 
  mutate(time = format(as.POSIXct(Date.Time), format = "%H:%M:%S")) %>% 
  mutate(time = as_hms(time))

# For heat flux
heatflux.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6, CH7, CH8)
heatflux.df.long <- heatflux.df %>% 
  select(date, time, ms, CH7, CH8) %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'sensor.id',
               values_to = 'heat.flux')

# Removing unncessary columns
thermocoupler.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6)

# Lengthening dataframe
thermocoupler.df.long <- thermocoupler.df %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'thermo.id',
               values_to = 'temp')

# Combining dataframes
temp.heat.flux.df <- merge(thermocoupler.df.long, heatflux.df.long, by = c('date', 'time', 'ms'))
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(sensor.location = case_when(
    sensor.id == 'CH7' ~ 'Top',
    sensor.id == 'CH8' ~ 'Left Side'
  ))
```

## Flammability Data
### Clocktime, Date Wrangling
```{r}
flam.df <- flam.df %>% 
  mutate(start_time = start_time_clocktime) %>% 
  mutate(primary_ignition = firstigstart_time_clock_time) %>% 
  mutate(primary_time_of_flame_end = firstigend_time_clock_time) %>% 
  mutate(secondary_ignition = secondigstart_time_clock_time) %>% 
  mutate(secondary_time_of_flame_end = secondigend_time_clock_time) %>% 
  mutate(time_of_glow_end = end_time_clock_time) %>% 
  mutate(time_fh = maxflameht_time_clock_time) %>% 
  rename(fh = max_flame_height) %>% 
  select(-c(start_time_clocktime, firstigstart_time_clock_time, firstigend_time_clock_time, secondigstart_time_clock_time, secondigend_time_clock_time, end_time_clock_time, maxflameht_time_clock_time, time_of_max_flame_height))

flam.df <- replace(flam.df, flam.df=='', NA)

flam.df <- flam.df %>% 
  mutate(start_time = as_hms(format(as.POSIXct(start_time), format = "%H:%M:%S"))) %>% 
  mutate(primary_ignition = as_hms(format(as.POSIXct(primary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(primary_time_of_flame_end = as_hms(format(as.POSIXct(primary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(secondary_ignition = as_hms(format(as.POSIXct(secondary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(secondary_time_of_flame_end = as_hms(format(as.POSIXct(secondary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(time_of_glow_end = as_hms(format(as.POSIXct(time_of_glow_end), format = "%H:%M:%S"))) %>% 
  mutate(time_fh = as_hms(format(as.POSIXct(time_fh), format = "%H:%M:%S"))) %>% 
  mutate(date = as.Date(date))
```

### Calculating Flam. Metrics (1)
Flame duration, time to ignition, post-flame glow
```{r}
# Getting the time and date in the right format
flam.df <- flam.df %>% 
  mutate(pre_ignition_glow = as.numeric(pre_ignition_glow)) %>% 
  mutate(fh = as.numeric(fh)) %>% 
  # FLAME DURATION
  mutate(fd = primary_time_of_flame_end - primary_ignition) %>% 
  mutate(fd = as.numeric(fd)) %>% 
  # TIME TO IGNITION
  mutate(tti = primary_ignition - start_time) %>% 
  mutate(tti = as.numeric(tti)) %>% 
  # POST FLAME GLOW
  mutate(pfg = time_of_glow_end - primary_time_of_flame_end) %>% 
  mutate(pfg = as.numeric(pfg))
```

### Calculating Temp. Metrics
Maximum Temperature
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_temp = NA) %>% 
  mutate(time_at_max_temp = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) #again, index row, select columns
  flam.df$max_temp[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp[i] <- df.mt$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp = as_hms(time_at_max_temp))

rm(df, df.mt) # Decluttering environment by removing temporary dataframes from above for loop
```

Starting Temp. and Temp. Change
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(start_temp = NA)
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>% 
    filter(time == flam.df$start_time[i]) %>% 
    filter(ms == 0)
  flam.df$start_temp[i] <- max(df$temp)
}
flam.df <- flam.df %>% 
  mutate(temp_change = max_temp - start_temp)

rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

### Calculating Heat Flux
#### Max. Heat Flux
Still deciding on what to use here... top sensor, side sensor, avg of both?

Raw data
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_heat_flux = NA) %>% 
  mutate(time_at_max_heat_flux = NA)
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(max_heat_flux = NA) 
for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns
  flam.df$max_heat_flux[i] <- max(df$heat.flux)
  df$max_heat_flux <- case_when(df$heat.flux == flam.df$max_heat_flux[i] ~ 'yes')
  df.mhf <- df %>% 
    filter(max_heat_flux == 'yes')
  flam.df$time_at_max_heat_flux[i] <- df.mhf$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_heat_flux = as_hms(time_at_max_heat_flux))

rm(df, df.mhf) # Decluttering environment by removing temporary dataframes from above for loop
```

Loess regressions
```{r}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_loessCH7 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH7 = NA) %>% 
  mutate(max_heat_flux_loessCH8 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = NA)
heatflux.df <- heatflux.df %>% 
  mutate(max_heat_flux_loessCH7 = NA)  %>% 
  mutate(max_heat_flux_loessCH8 = NA)
# NOTE: THIS PART WILL NOT BE NECESSARY WHEN ALL DATALOGGER DATA IS INPUTTED
flam.df.no.Inf <- flam.df %>% 
  filter(max_heat_flux > 0)
flam.df.Inf <- flam.df %>% 
  filter(max_heat_flux < 0) 

for(i in 1:nrow(flam.df.no.Inf)){
  df <- heatflux.df %>% 
    filter(date == flam.df.no.Inf$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.no.Inf$start_time[i] & time <= flam.df.no.Inf$time_of_glow_end[i]) %>% #again, index row, select columns
    mutate(time = as.numeric(time))
  
# Loess regressions
  loess.mod.CH7 <- loess(CH7 ~ time, data = df, span = 0.0691)
  df$loess.CH7 <- predict(loess.mod.CH7)
  loess.mod.CH8 <- loess(CH8 ~ time, data = df, span = 0.0337)
  df$loess.CH8 <- predict(loess.mod.CH8)

  flam.df.no.Inf$max_heat_flux_loessCH7[i] <- max(df$loess.CH7)
  flam.df.no.Inf$max_heat_flux_loessCH8[i] <- max(df$loess.CH8)
  
  df$max_heat_flux_loessCH7 <- case_when(df$loess.CH7 == flam.df.no.Inf$max_heat_flux_loessCH7[i] ~ 'yes')
  df$max_heat_flux_loessCH8 <- case_when(df$loess.CH8 == flam.df.no.Inf$max_heat_flux_loessCH8[i] ~ 'yes')
  
  df.mhf_CH7 <- df %>% 
    filter(max_heat_flux_loessCH7 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH7[i] <- df.mhf_CH7$time[1]
  df.mhf_CH8 <- df %>% 
    filter(max_heat_flux_loessCH8 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH8[i] <- df.mhf_CH8$time[1]
}
flam.df.no.Inf <- flam.df.no.Inf %>% 
  mutate(time_at_max_heat_flux_loessCH7 = as_hms(time_at_max_heat_flux_loessCH7)) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = as_hms(time_at_max_heat_flux_loessCH8))

flam.df <- rbind(flam.df.no.Inf, flam.df.Inf)

rm(df, df.mhf_CH7, df.mhf_CH8) # Decluttering environment by removing temporary dataframes from above for loop
```

#### Avg. Heat Flux (flame duration)
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH7') %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

#### Optimization Routine
Since maximum heat flux is going to be determined using Loess regressions, this optimization routine selects the optimal smoothing span to use when looking at heat flux over time
```{r, warning = FALSE}
flam.df.sample <- sample_n(flam.df.no.Inf, 50)

CH7results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))
colnames(CH7results) <- colnames(best)

CH8results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))
colnames(CH8results) <- colnames(best)

ctrl <- trainControl(method = "cv", number = 5)
grid <- expand.grid(span = seq(0.01, 0.5, len = 50), degree = 1)

for(i in 1:length(flam.df.sample)){
  df <- heatflux.df %>% 
    filter(date == flam.df.sample$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.sample$start_time[i] & time <= flam.df.sample$time_of_glow_end[i]) %>% 
    mutate(time = as.numeric(time))
  
  CH7model <- train(CH7 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)
  
  CH8model <- train(CH8 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)

  ch7.res <- as.data.frame(CH7model$results)
  ch7.best <- ch7.res[which.min(ch7.res$RMSE),]
  CH7results[i,] <- ch7.best
  
  ch8.res <- as.data.frame(CH8model$results)
  ch8.best <- ch8.res[which.min(ch8.res$RMSE),]
  CH8results[i,] <- ch8.best
}

CH7results <- na.omit(CH7results)
mean(CH7results$span) # 0.0691

CH8results <- na.omit(CH8results)
mean(CH8results$span) # 0.0337

rm(df, ch7.res, ch7.best, ch8.res, ch8.best) # Decluttering environment by removing temporary dataframes from above for loop
```

### Proportion Ignited
```{r}
flam.df.prop.ig1 <- flam.df %>% 
  group_by(species) %>%
  summarise(n = n()) %>% 
  ungroup() 
  
flam.df.prop.ig2 <- flam.df %>% 
  filter(ignition %in% c('M', '0')) %>% 
  group_by(species) %>% 
  summarise(manual_or_nonignitions = n()) %>% 
  select(manual_or_nonignitions)

flam.df.prop.ig <- cbind(flam.df.prop.ig1, flam.df.prop.ig2) %>% 
  mutate(prop_ig = (n-manual_or_nonignitions)/n) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUGL', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) # note that EUGL needs to change to EUCGLO

rm(flam.df.prop.ig1, flam.df.prop.ig2) # Decluttering environment by removing temporary dataframes

flam.df.prop.ig <- flam.df.prop.ig %>% 
  select(species, prop_ig)
flam.df <- merge(flam.df, flam.df.prop.ig, by = 'species')
```

### Small Adjustments/Fixes
```{r}
flam.df <- flam.df %>% 
  mutate(total_branch_mass = as.numeric(total_branch_mass) - 16.9336) %>% 
  rename(sample_wt = total_branch_mass) %>% 
  mutate(branch_width = as.numeric(branch_width)) %>% 
  select(-X)
```

# Saving .csv
```{r}
write_csv(flam.df, here('data', 'processed-data', 'clean_flamm_data.csv'))
```