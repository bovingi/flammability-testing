---
title: 'Data Wrangling: Flammability'
author: "Joe Celebrezze"
date: "2023-04-14"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(ggfortify)
library(hms)
library(caret) # for optimization routine

# defining functions
here = here::here

# reading in data
thermocoupler.files <- list.files(here('data', 'raw-data', 'thermocouplers'))
thermocoupler.df.list <- list()
for(i in 1:length(thermocoupler.files)){
  df <- read.csv(here('data', 'raw-data', 'thermocouplers', thermocoupler.files[[i]]))
  thermocoupler.df.list[[i]] <- df
}

flam.df <- read.csv(here('data', 'raw-data', 'flamm', 'burn_samples_flamm_clocktime.csv'))
```

# Data Wrangling
## Datalogger Data
This includes data from the thermocouplers (CH1-6) as well as the heat flux sensors (CH7-8); the datalogger took data every 500 ms
```{r}
# Combining thermocoupler datasheets
thermocoupler.df <- do.call('rbind', thermocoupler.df.list)

# Getting temperature data in correct format
for(i in 4:11){
thermocoupler.df[,i] <- thermocoupler.df[,i] %>% 
  str_replace(pattern = '\\+ ', replacement = ' ') %>% 
  str_trim(side = c('left'))
thermocoupler.df[,i] <- as.numeric(thermocoupler.df[,i])
}
thermocoupler.df <- na.omit(thermocoupler.df)

# Splitting date and time into two columns
thermocoupler.df <- thermocoupler.df %>% 
  mutate(Date.Time = as.POSIXct(Date.Time) + 80) %>%  # Adjusting time so it matches time on clock
  mutate(date = as.Date(Date.Time)) %>% 
  mutate(time = format(as.POSIXct(Date.Time), format = "%H:%M:%S")) %>% 
  mutate(time = as_hms(time))

# For heat flux
heatflux.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6, CH7, CH8)
heatflux.df.long <- heatflux.df %>% 
  select(date, time, ms, CH7, CH8) %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'sensor.id',
               values_to = 'heat.flux')

# Removing unncessary columns
thermocoupler.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6)

# Lengthening dataframe
thermocoupler.df.long <- thermocoupler.df %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'thermo.id',
               values_to = 'temp')

# Combining dataframes
temp.heat.flux.df <- merge(thermocoupler.df.long, heatflux.df.long, by = c('date', 'time', 'ms'))
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(sensor.location = case_when(
    sensor.id == 'CH7' ~ 'Top',
    sensor.id == 'CH8' ~ 'Left Side'
  ))
```

## Flammability Data
### Clocktime, Date Wrangling
```{r}
flam.df <- flam.df %>% 
  mutate(start_time = start_time_clocktime) %>% 
  mutate(primary_ignition = firstigstart_time_clock_time) %>% 
  mutate(primary_time_of_flame_end = firstigend_time_clock_time) %>% 
  mutate(secondary_ignition = secondigstart_time_clock_time) %>% 
  mutate(secondary_time_of_flame_end = secondigend_time_clock_time) %>% 
  mutate(time_of_glow_end = end_time_clock_time) %>% 
  mutate(time_fh = maxflameht_time_clock_time) %>% 
  select(-c(start_time_clocktime, firstigstart_time_clock_time, firstigend_time_clock_time, secondigstart_time_clock_time, secondigend_time_clock_time, end_time_clock_time, maxflameht_time_clock_time))

flam.df <- replace(flam.df, flam.df=='', NA)

flam.df <- flam.df %>% 
  mutate(start_time = as_hms(format(as.POSIXct(start_time), format = "%H:%M:%S"))) %>% 
  mutate(primary_ignition = as_hms(format(as.POSIXct(primary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(primary_time_of_flame_end = as_hms(format(as.POSIXct(primary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(secondary_ignition = as_hms(format(as.POSIXct(secondary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(secondary_time_of_flame_end = as_hms(format(as.POSIXct(secondary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(time_of_glow_end = as_hms(format(as.POSIXct(time_of_glow_end), format = "%H:%M:%S"))) %>% 
  mutate(time_fh = as_hms(format(as.POSIXct(time_fh), format = "%H:%M:%S"))) %>% 
  mutate(date = as.Date(date))
```

### Calculating Flam. Metrics (1)
Flame duration, time to ignition, post-flame glow
```{r}
flam.df <- flam.df %>% 
  mutate(pre_ignition_glow = as.numeric(pre_ignition_glow)) %>% 
  mutate(fh = as.numeric(fh)) %>% 
  # FLAME DURATION
  mutate(fd = primary_time_of_flame_end - primary_ignition) %>% 
  mutate(fd = as.numeric(fd)) %>% 
  # TIME TO IGNITION
  mutate(tti = primary_ignition - start_time) %>% 
  mutate(tti = as.numeric(tti)) %>% 
  # POST FLAME GLOW
  mutate(pfg = time_of_glow_end - primary_time_of_flame_end) %>% 
  mutate(pfg = as.numeric(pfg))
```

### Calculating Temp. Metrics
Maximum Temperature (needs to be changed back to how it was (none of this max_temp2 nonsense))
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_temp = NA) %>% 
  mutate(time_at_max_temp = NA) %>% 
  mutate(max_temp_sensor = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(thermo.id %in% c('CH1', 'CH2', 'CH5', 'CH6')) %>% # if we want to exclude vent thermocoupler, top glass thermocoupler
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) #again, index row, select columns
  flam.df$max_temp[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp[i] <- df.mt$time[1]
  flam.df$max_temp_sensor[i] <- df.mt$thermo.id[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp = as_hms(time_at_max_temp))

#rm(df, df.mt) # Decluttering environment by removing temporary dataframes from above for loop
```

Starting Temp. and Temp. Change
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(start_temp = NA) %>% 
  mutate(start_temp_sensor = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(start_temp = 'yes')
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(thermo.id %in% c('CH1', 'CH2', 'CH5', 'CH6')) %>% # if we want to exclude vent thermocoupler, top glass thermocoupler
    filter(date == flam.df$date[i]) %>% 
    filter(time == flam.df$start_time[i]) %>% 
    filter(ms == 0)
  flam.df$start_temp[i] <- max(df$temp)
  df$start_temp <- case_when(df$temp == flam.df$start_temp[i] ~ 'yes')
  df.st <- df %>% 
    filter(start_temp == 'yes')
  flam.df$start_temp_sensor[i] <- df.st$thermo.id[1]
}
flam.df <- flam.df %>% 
  mutate(temp_change = max_temp - start_temp)

rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

### Calculating Heat Flux
#### Max. Heat Flux
Still deciding on what to use here... top sensor, side sensor, avg of both?

Raw data
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_heat_flux = NA) %>% 
  mutate(time_at_max_heat_flux = NA)
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(max_heat_flux = NA) 
for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns
  flam.df$max_heat_flux[i] <- max(df$heat.flux)
  df$max_heat_flux <- case_when(df$heat.flux == flam.df$max_heat_flux[i] ~ 'yes')
  df.mhf <- df %>% 
    filter(max_heat_flux == 'yes')
  flam.df$time_at_max_heat_flux[i] <- df.mhf$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_heat_flux = as_hms(time_at_max_heat_flux))

rm(df, df.mhf) # Decluttering environment by removing temporary dataframes from above for loop
```

Loess regressions
```{r}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_loessCH7 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH7 = NA) %>% 
  mutate(max_heat_flux_loessCH8 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = NA)
heatflux.df <- heatflux.df %>% 
  mutate(max_heat_flux_loessCH7 = NA)  %>% 
  mutate(max_heat_flux_loessCH8 = NA)
# NOTE: THIS PART WILL NOT BE NECESSARY WHEN ALL DATALOGGER DATA IS INPUTTED
flam.df.no.Inf <- flam.df %>% 
  filter(max_heat_flux > 0)
flam.df.Inf <- flam.df %>% 
  filter(max_heat_flux < 0) 

for(i in 1:nrow(flam.df.no.Inf)){
  df <- heatflux.df %>% 
    filter(date == flam.df.no.Inf$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.no.Inf$start_time[i] & time <= flam.df.no.Inf$time_of_glow_end[i]) %>% #again, index row, select columns
    mutate(time = as.numeric(time))
  
# Loess regressions
  loess.mod.CH7 <- loess(CH7 ~ time, data = df, span = 0.09826087)
  df$loess.CH7 <- predict(loess.mod.CH7)
  loess.mod.CH8 <- loess(CH8 ~ time, data = df, span = 0.02608696)
  df$loess.CH8 <- predict(loess.mod.CH8)

  flam.df.no.Inf$max_heat_flux_loessCH7[i] <- max(df$loess.CH7)
  flam.df.no.Inf$max_heat_flux_loessCH8[i] <- max(df$loess.CH8)
  
  df$max_heat_flux_loessCH7 <- case_when(df$loess.CH7 == flam.df.no.Inf$max_heat_flux_loessCH7[i] ~ 'yes')
  df$max_heat_flux_loessCH8 <- case_when(df$loess.CH8 == flam.df.no.Inf$max_heat_flux_loessCH8[i] ~ 'yes')
  
  df.mhf_CH7 <- df %>% 
    filter(max_heat_flux_loessCH7 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH7[i] <- df.mhf_CH7$time[1]
  df.mhf_CH8 <- df %>% 
    filter(max_heat_flux_loessCH8 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH8[i] <- df.mhf_CH8$time[1]
}
flam.df.no.Inf <- flam.df.no.Inf %>% 
  mutate(time_at_max_heat_flux_loessCH7 = as_hms(time_at_max_heat_flux_loessCH7)) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = as_hms(time_at_max_heat_flux_loessCH8))

flam.df <- rbind(flam.df.no.Inf, flam.df.Inf)

rm(df, df.mhf_CH7, df.mhf_CH8) # Decluttering environment by removing temporary dataframes from above for loop
```

#### Avg. Heat Flux (flame duration)
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH8') %>% # looking at side sensor only (less noise)
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

#### Optimization Routine
Since maximum heat flux is going to be determined using Loess regressions, this optimization routine selects the optimal smoothing span to use when looking at heat flux over time
```{r, warning = FALSE}
flam.df.sample <- sample_n(flam.df.no.Inf, 50)

CH7results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))

CH8results <- data.frame(matrix(NA,    # Create empty data frame
                          nrow = 50,
                          ncol = 8))

ctrl <- trainControl(method = "cv", number = 5)
grid <- expand.grid(span = seq(0.01, 0.5, len = 50), degree = 1)

for(i in 1:length(flam.df.sample)){
  df <- heatflux.df %>% 
    filter(date == flam.df.sample$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.sample$start_time[i] & time <= flam.df.sample$time_of_glow_end[i]) %>% 
    mutate(time = as.numeric(time))
  
  CH7model <- train(CH7 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)
  
  CH8model <- train(CH8 ~ time, data = df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)

  ch7.res <- as.data.frame(CH7model$results)
  ch7.best <- ch7.res[which.min(ch7.res$RMSE),]
  CH7results[i,] <- ch7.best
  
  ch8.res <- as.data.frame(CH8model$results)
  ch8.best <- ch8.res[which.min(ch8.res$RMSE),]
  CH8results[i,] <- ch8.best
}

colnames(CH7results) <- colnames(ch7.best)
CH7results <- na.omit(CH7results)
mean(CH7results$span) # 0.0983

colnames(CH8results) <- colnames(ch8.best)
CH8results <- na.omit(CH8results)
mean(CH8results$span) # 0.0261

rm(df, ch7.res, ch7.best, ch8.res, ch8.best) # Decluttering environment by removing temporary dataframes from above for loop
```

### Proportion Ignited
```{r}
flam.df.prop.ig1 <- flam.df %>% 
  group_by(species) %>%
  dplyr::summarise(n = n()) %>% 
  ungroup() 
  
flam.df.prop.ig2 <- flam.df %>% 
  filter(ignition %in% c('M', '0')) %>% 
  group_by(species) %>% 
  dplyr::summarise(manual_or_nonignitions = n()) %>% 
  select(manual_or_nonignitions)

flam.df.prop.ig <- cbind(flam.df.prop.ig1, flam.df.prop.ig2) %>% 
  mutate(prop_ig = (n-manual_or_nonignitions)/n) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUGL', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) # note that EUGL needs to change to EUCGLO

rm(flam.df.prop.ig1, flam.df.prop.ig2) # Decluttering environment by removing temporary dataframes

flam.df.prop.ig <- flam.df.prop.ig %>% 
  select(species, prop_ig)
flam.df <- merge(flam.df, flam.df.prop.ig, by = 'species')
```

### Small Adjustments/Fixes
```{r}
flam.df <- flam.df %>% 
  mutate(total_branch_mass = as.numeric(total_branch_mass) - 16.9336) %>% 
  mutate(branch_width = as.numeric(branch_width)) %>% 
  select(-X)
```

# Exploratory heat flux figures 
(will remove later, but currently in process of figuring out heat flux)
```{r}
flam.df %>% 
  mutate(max_heat_flux_loessAVG = (max_heat_flux_loessCH7 + max_heat_flux_loessCH8)/2) %>% 
  ggplot(aes(x = max_heat_flux_loessCH8, y = max_heat_flux_loessAVG)) +
    geom_point() +
    geom_abline(linetype = 4) +
    geom_smooth(method = 'lm', color = 'black') +
    labs(x = 'Max. Heat Flux (Loess, Side Sensor)', y = 'Max. Heat Flux (Loess Avg.)') +
    theme_bw()

flam.df %>%
  ggplot(aes(x = max_heat_flux_loessCH7, y = max_heat_flux_loessCH8)) +
    geom_point() +
    geom_abline(linetype = 4) +
    geom_smooth(method = 'lm', color = 'black') +
    labs(x = 'Max. Heat Flux (Loess, Top Sensor)', y = 'Max. Heat Flux (Loess, Side Sensor)') +
    theme_bw()

flam.df %>% 
  mutate(max_heat_flux_loessAVG = (max_heat_flux_loessCH7 + max_heat_flux_loessCH8)/2) %>% 
  ggplot(aes(x = max_heat_flux_loessAVG, y = avg_fd_heat_flux)) +
    geom_point() +
    geom_abline(linetype = 4) +
    geom_smooth(method = 'lm', color = 'black') +
    labs(x = 'Max. Heat Flux (Loess Avg.)', y = 'Avg. Heat Flux (during flame duration)') +
    theme_bw()

flam.df %>%
  ggplot(aes(x = max_heat_flux_loessCH8, y = avg_fd_heat_flux)) +
    geom_point() +
    geom_abline(linetype = 4) +
    geom_smooth(method = 'lm', color = 'black') +
    labs(x = 'Max. Heat Flux (Loess, Side Sensor)', y = 'Avg. Heat Flux (during flame duration)') +
    theme_bw()
```

```{r}
heatflux.vis <- function(index){
heatflux.df.woop <- heatflux.df %>% 
  filter(date == flam.df.no.Inf$date[index]) %>%  #index row, select column for date
  filter(time >= flam.df.no.Inf$start_time[index] & time <= flam.df.no.Inf$time_of_glow_end[index]) %>% 
  mutate(time = as.numeric(time))

loess.mod.CH7 <- loess(CH7 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0983)
heatflux.df.woop$loess.CH7 <- predict(loess.mod.CH7)

ch7.title <- paste('Top Sensor (span = 0.0983)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.top <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH7), color = 'black') +
  geom_point(aes(y = CH7), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.95, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], y = 1, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Top Sensor)', title = ch7.title) +
  theme_bw() + 
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))

loess.mod.CH8 <- loess(CH8 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0261)
heatflux.df.woop$loess.CH8 <- predict(loess.mod.CH8)

ch8.title <- paste('Side Sensor (span = 0.0261)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.side <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH8), color = 'black') +
  geom_point(aes(y = CH8), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.5, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], y = 0.55, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Side Sensor)', title = ch8.title) +
  theme_bw() +  
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))
print(plot.side)
print(plot.top)
}
```

```{r}
heatflux.vis(234)
```

Boxplots
```{r}
ggplot(flam.df.no.Inf, aes(x = ignition, y = max_heat_flux_loessCH8)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.02, alpha = 0.4, aes(color = species)) +
  labs(x = 'Ignition', y = 'Max. Heat Flux (Side Sensor, Loess)', color = "Species") +
  theme_bw()

ggplot(flam.df.no.Inf, aes(x = ignition, y = max_heat_flux_loessCH7)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.02, alpha = 0.4, aes(color = species)) +
  labs(x = 'Ignition', y = 'Max. Heat Flux (Top Sensor, Loess)', color = "Species") +
  theme_bw()

ggplot(flam.df.no.Inf, aes(x = ignition, y = max_heat_flux)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.02, alpha = 0.4, aes(color = species)) +
  labs(x = 'Ignition', y = 'Max. Heat Flux (Raw Values)', color = "Species") +
  theme_bw()
```


# Saving .csv
```{r}
write_csv(flam.df, here('data', 'processed-data', 'clean_flamm_data.csv'))
```
