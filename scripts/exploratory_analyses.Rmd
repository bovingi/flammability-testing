---
title: "Exploratory Analyses"
author: "Joe Celebrezze"
date: "2023-03-30"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(ggfortify)
library(ggbiplot) #for nicer PCA plots
library(psych) #for pairs.panels()
library(sjPlot) #for nice tables of eigenvalues
library(factoextra) #for k-means clustering

# defining functions
here = here::here
ggbiplot = ggbiplot::ggbiplot

# reading in data
flamm.df <- read.csv(here('data', 'processed-data', 'main_plant_flammability.csv'))
```

# Summary Boxplots
## Plant Traits
```{r}
traits.df.long <- flamm.df %>% 
  select(date, species, plant, rep, leaf_lfm, stem_lfm, lfm, leaf_area, SLA,
         thickness, branch_length, branch_width, branch_height, sample_wt,
         branching, mpa, stem_mass_ratio, leaf_mass_ratio) %>% 
  filter(branch_height < 100) %>% 
  pivot_longer(!c(date, species, plant, rep), names_to = 'trait', values_to = 'value')

ggplot(traits.df.long, aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 2, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 15))

ggsave(here('figures', 'plant.traits.exploratory.boxplot.jpg'), height = 20, width = 16)
```

## Flammability Metrics
```{r}
flamm.df.long <- flamm.df %>% 
  select(date, species, plant, rep, mpa, leaf_lfm, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt, fh, fd, tti, pfg, max_temp, max_heat_flux, max_heat_flux_loessCH7, max_heat_flux_loessCH8) %>%  # took out  gd, gti, ttfg for now
  pivot_longer(!c(date, species, plant, rep, mpa, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt), names_to = 'trait', values_to = 'value') %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUCGLO', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) #note that EUGL needs to change to EUCGLO

flamm.df.long %>% 
ggplot(aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

ggsave(here('figures', 'flamm.metrics.exploratory.boxplot.jpg'), height = 12, width = 20)
```

## Normalized Flamm. Metrics
```{r}
flamm.df.long %>% 
  mutate(norm_value = value/as.numeric(total_branch_mass)) %>% 
ggplot(aes(x = species, y = norm_value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Normalized Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

ggsave(here('figures', 'normalized.flamm.metrics.exploratory.boxplot.jpg'), height = 12, width = 20)
```


# Scatterplots
## Function
```{r}
exploratory_scatterplot <- function(expl.var, x.lab){
  flamm.df.long %>% 
  filter(trait %in% c('fd', 'fh', 'max_heat_flux', 'max_heat_flux_loessCH7', 'max_heat_flux_loessCH8', 'max_temp', 'pfg', 'tti')) %>% 
  ggplot(aes(x = expl.var, y = value, color = species)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = 'lm', linewidth = 1, alpha = 0.8, se = F) +
  labs(x = x.lab, y = 'Flamm. Metric Value', color = 'Species')  +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        legend.title = element_text(face = 'bold', size = 16),
        legend.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16))
}
```

## Vs. Hydration
Water Potential
```{r}
exploratory_scatterplot(flamm.df.long$mpa, 'Water Potential (MPa)')

ggsave(here('figures', 'flamm.metrics.vs.mpa.exploratory.jpg'), height = 12, width = 20)
```

LFM
```{r}
#  erikar causing issues due to very high LFM values
exploratory_scatterplot(flamm.df.long$lfm, 'Live Fuel Moisture (%)')
ggsave(here('figures', 'flamm.metrics.vs.lfm.exploratory.jpg'), height = 12, width = 20)

exploratory_scatterplot(flamm.df.long$leaf_lfm, 'Leaf Live Fuel Moisture (%)')
exploratory_scatterplot(flamm.df.long$stem_lfm, 'Stem Live Fuel Moisture (%)')
```

## Vs. Sample Weight
```{r}
exploratory_scatterplot(flamm.df.long$sample_wt, 'Sample Weight (g)')

ggsave(here('figures', 'flamm.metrics.vs.sample.wt.exploratory.jpg'), height = 12, width = 20)
```

## Vs. Leaf Metrics
```{r}
exploratory_scatterplot(flamm.df.long$LMA, 'Leaf Mass per Area')
exploratory_scatterplot(flamm.df.long$SLA, 'Specific Leaf Area')
exploratory_scatterplot(flamm.df.long$thickness, 'Leaf Thickness')
```

# Proportion Ignited
```{r}
flamm.df %>% 
  group_by(species) %>%
  summarise(n = n(), prop_ig = prop_ig) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) %>% 
  ggplot(aes(x = species, y = prop_ig, color = species)) +
    scale_y_continuous(limits = c(0,1)) +
    geom_point(size = 6) +
    geom_text(aes(label = n, x = species, y = prop_ig + 0.1)) +
    labs(x = ' ', y = 'Proportion Ignited') +
    theme_bw() + 
    theme(legend.position = 'none')
```

# PCAs
## Flamm Metrics
```{r}
# selecting metrics of interest
flamm_pca_df <- flamm.df %>% 
  select(fd, tti, fh, prop_ig, max_heat_flux_loessCH8, max_temp, pfg, species)

# looking at correlation and distribution
pairs.panels(flamm_pca_df)

# prepping dataset for PCA
flamm_pca_df <- flamm_pca_df %>% 
  na.omit() %>%  # Getting rid of NAs, which currently drops 113 samples :( -- need to find a way to limit
  filter(max_temp > 0) # Getting rid of -Inf values

# running PCA
flamm_pca <- flamm_pca_df %>% 
  select(-species) %>% 
  prcomp(center = TRUE, scale = TRUE) 

# first glance at results
summary(flamm_pca)
plot(flamm_pca, type = 'lines') # first 2 explain 51.86% variance
print(flamm_pca) # PC1: flame height, flame duration, max temp and max heat flux (combustibility), PC2: time to ignition, proportion ignited, post-flame glow (ignitability and consumability)

# visualizing results
ggbiplot(flamm_pca,
         groups = flamm_pca_df$species,
         ellipse = TRUE, varname.size = 5, alpha = 0.5) +
  scale_color_manual(values = c('black', 'gray50', 'goldenrod', 'skyblue', 'red', 'darkblue', 'deeppink', 'brown', 'yellowgreen')) +
  theme_bw()

# eigenvalue table
tab_pca(flamm_pca, rotation = 'varimax')
```

## Leaf Traits
```{r}
# selecting metrics of interest
traits_pca_df <- flamm.df %>% 
  select(leaf_mass_ratio, leaf_lfm, stem_lfm, lfm, thickness, mpa, SLA, sample_wt, species)

# looking at correlation and distribution
pairs.panels(traits_pca_df)

# prepping dataset for PCA
traits_pca_df <- traits_pca_df %>% 
  na.omit()  # Getting rid of NAs, which currently drops 36 samples

# running PCA
traits_pca <- traits_pca_df %>% 
  select(-species) %>% 
  prcomp(center = TRUE, scale = TRUE) 

# first glance at results
summary(traits_pca)
plot(traits_pca, type = 'lines') # first 2 explain 47.99% variance
print(traits_pca) # PC1: stem LFM, LFM, leaf mass ratio, PC2: SLA, lfm, leaf LFM, PC3: LFM, MPa

# visualizing results
ggbiplot(traits_pca,
         groups = traits_pca_df$species,
         ellipse = TRUE, varname.size = 5, alpha = 0.5) +
  scale_color_manual(values = c('black', 'gray50', 'goldenrod', 'skyblue', 'red', 'darkblue', 'deeppink', 'brown', 'yellowgreen')) +
  theme_bw()

# eigenvalue table
tab_pca(traits_pca, rotation = 'varimax')
```

# k-means Clustering
## Flamm Metrics
```{r}
# prepping dataset
id <- c(1:nrow(flamm_pca_df))
flamm_kmeans_df <- cbind(flamm_pca_df, id) %>% 
  unite('species_id', c(species, id), remove = F)

rownames(flamm_kmeans_df) <- flamm_kmeans_df$species_id

flamm_kmeans_scaled_df <- flamm_kmeans_df %>% 
  select(-c(species_id, species, id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "wss") #k = 7 or k = 4
# 2. silhouette method
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "silhouette") #k = 8

# run k-means clustering
#perform k-means clustering with k = 8 clusters
km <- kmeans(flamm_kmeans_scaled_df, centers = 8)
#plot results of final k-means model
fviz_cluster(km, data = flamm_kmeans_scaled_df)
#add cluster assigment to original data
flamm_kmeans_df <- cbind(flamm_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
flamm_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(flamm_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #')

flamm_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count')
```

## Leaf Traits
```{r}
# prepping dataset
id <- c(1:nrow(traits_pca_df))
traits_kmeans_df <- cbind(traits_pca_df, id) %>% 
  unite('species_id', c(species, id), remove = F)

rownames(traits_kmeans_df) <- traits_kmeans_df$species_id

traits_kmeans_scaled_df <- traits_kmeans_df %>% 
  select(-c(species_id, species, id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "wss") #k = 2, 4 or 7
# 2. silhouette method
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "silhouette") #k = 2, 4, 7, or 9

# run k-means clustering
#perform k-means clustering with k = 8 clusters (note k = 2 and k = 4 looked unhelpful)
km <- kmeans(traits_kmeans_scaled_df, centers = 7)
#plot results of final k-means model
fviz_cluster(km, data = traits_kmeans_scaled_df)
#add cluster assigment to original data
traits_kmeans_df <- cbind(traits_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
traits_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(traits_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #')

traits_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count')
```

# Binomial Regressions
Looking at ignition vs. non-ignition/manual ignition
## Visualizations
```{r}
# prepping dataset
flamm_binomial_df <- flamm.df %>% 
  mutate(ignition = case_when(ignition == 'M' ~ 0,
                             ignition == '1' ~ 1,
                             ignition == '0' ~ 0))

# writing function
exploratory_binomial <- function(expl.var, x.lab){
  ggplot(data = flamm_binomial_df, aes(x=expl.var, y=ignition)) + 
  geom_point(alpha=.5) +
  facet_wrap(~species, scales = 'free_x') +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) +
  scale_y_continuous(breaks = c(0,1)) +
  theme_bw() +
  theme(strip.text = element_text(face = 'bold', size = 15),
        axis.title = element_text(face = 'bold', size = 16)) +
  labs(x = x.lab, y = "Ignition?", title = "Binomial Regression")}

# looking at a bunch of different explanatory variables
exploratory_binomial(flamm_binomial_df$mpa, 'Water Potential (MPa)')
exploratory_binomial(flamm_binomial_df$lfm, 'Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$leaf_lfm, 'Leaf Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$stem_lfm, 'Stem Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$LMA, 'Leaf Mass Area')
exploratory_binomial(flamm_binomial_df$sample_wt, 'Sample Weight (g)')
exploratory_binomial(flamm_binomial_df$start_temp, 'Starting Temperature (C)')
```

## Significance
```{r}
# writing function
binomial_significance <- function(spp){
df <- flamm_binomial_df %>% 
  filter(species == spp)

m1 <- glm(ignition ~ lfm + sample_wt, data = df, family = "binomial")
print(paste0(spp, ': LFM P-value = ', summary(m1)$coefficients[2,4]))

m2 <- glm(ignition ~ mpa + sample_wt, data = df, family = "binomial")
print(paste0(spp,': MPa P-value = ', summary(m2)$coefficients[2,4]))

m3 <- glm(ignition ~ LMA + sample_wt, data = df, family = "binomial")
print(paste0(spp, ': LMA P-value = ', summary(m3)$coefficients[2,4]))

m4 <- glm(ignition ~ sample_wt, data = df, family = "binomial")
print(paste0(spp, ': Sample Wt. P-value = ', summary(m4)$coefficients[2,4]))

df2 <- df %>% 
  filter(start_temp > 0)
m5 <- glm(ignition ~ start_temp + sample_wt, data = df2, family = "binomial")
print(paste0(spp, ': Starting Temp. P-value = ', summary(m5)$coefficients[2,4]))
}

# Running on all species that have at least 2 ignitions
binomial_significance('SALLEU')
binomial_significance('SALAPI')
binomial_significance('ARTCAL') # sample weight, MPa are significant
binomial_significance('CEAGRI')
binomial_significance('QUEAGR')
```

# Investigating Hot Plate/Thermocoupler Height
```{r}

```

