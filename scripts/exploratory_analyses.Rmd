---
title: "Exploratory Analyses"
author: "Joe Celebrezze"
date: "2023-03-30"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(ggfortify)
library(ggpubr)
library(ggbiplot) #for nicer PCA plots
library(psych) #for pairs.panels()
library(sjPlot) #for nice tables of eigenvalues
library(factoextra) #for k-means clustering

# defining functions
here = here::here
ggbiplot = ggbiplot::ggbiplot

# reading in data
flamm.df <- read.csv(here('data', 'processed-data', 'main_plant_flammability.csv'))
```

# Summary Boxplots
## Plant Traits
```{r}
traits.df.long <- flamm.df %>% 
  select(date, species, plant, rep, leaf_lfm, stem_lfm, lfm, leaf_area, SLA,
         thickness, branch_length, branch_width, branch_height, sample_wt,
         branching, mpa, stem_mass_ratio, leaf_mass_ratio) %>% 
  filter(branch_height < 100) %>% 
  pivot_longer(!c(date, species, plant, rep), names_to = 'trait', values_to = 'value')

ggplot(traits.df.long, aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 3, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 20),
        axis.text = element_text(size = 18),
        strip.text = element_text(face = 'bold', size = 20),
        axis.text.x = element_text(angle = 18))

ggsave(here('figures', 'plant.traits.exploratory.boxplot.jpg'), height = 20, width = 26)
```

## Flammability Metrics
```{r}
flamm.df.long <- flamm.df %>% 
  select(date, species, plant, rep, mpa, branching, branch_height, branch_length, branch_width, leaf_lfm, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt, fh, fd, tti, pfg, max_temp, max_heat_flux, max_heat_flux_loessCH7, max_heat_flux_loessCH8) %>%  # took out  gd, gti, ttfg for now
  pivot_longer(!c(date, species, plant, rep, mpa, branching, branch_height, branch_length, branch_width, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt), names_to = 'trait', values_to = 'value') %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUCGLO', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) #note that EUGL needs to change to EUCGLO

flamm.df.long %>% 
ggplot(aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

flamm.df.long %>% 
  filter(trait %in% c('fd', 'fh', 'pfg')) %>% 
ggplot(aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

ggsave(here('figures', 'flamm.metrics.exploratory.boxplot.jpg'), height = 12, width = 20)
```

## Normalized Flamm. Metrics
```{r}
flamm.df.long %>% 
  mutate(norm_value = value/as.numeric(sample_wt)) %>% 
ggplot(aes(x = species, y = norm_value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Normalized Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

flamm.df.long %>% 
  filter(trait %in% c('fd', 'fh', 'pfg')) %>% 
  mutate(norm_value = value/as.numeric(sample_wt)) %>% 
ggplot(aes(x = species, y = norm_value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Normalized Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

ggsave(here('figures', 'normalized.flamm.metrics.exploratory.boxplot.jpg'), height = 12, width = 20)
```


# Scatterplots
## Function
```{r}
flamm.df.long.scatter <- flamm.df.long %>% 
  dplyr::filter(trait %in% c('fd', 'fh', 'max_temp', 'pfg'))

exploratory_scatterplot <- function(expl.var, x.lab){
flamm.df.long.scatter %>% 
  ggplot(aes(x = expl.var, y = value, color = species)) +
    geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = 'lm', linewidth = 1, alpha = 0.8, se = F) +
  labs(x = x.lab, y = 'Flamm. Metric Value', color = 'Species')  +
  facet_wrap(~trait, ncol = 2, scales = 'free_y') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        legend.title = element_text(face = 'bold', size = 16),
        legend.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16))
}
```


## Vs. Hydration
Water Potential
```{r}
exploratory_scatterplot(flamm.df.long.scatter$mpa, 'Water Potential (MPa)')

ggsave(here('figures', 'flamm.metrics.vs.mpa.exploratory.jpg'), height = 12, width = 20)
```

LFM
```{r}
#  erikar causing issues due to very high LFM values
#flamm.df.long.no.erikar <- flamm.df.long %>% 
#  filter(species != 'ERIKAR') %>% 
#  filter(species != 'SALLEU')
#exploratory_scatterplot(flamm.df.long.no.erikar$lfm, 'Live Fuel Moisture (%)')
#ggsave(here('figures', 'flamm.metrics.vs.lfm.exploratory.jpg'), height = 12, width = 20)

exploratory_scatterplot(flamm.df.long.scatter$leaf_lfm, 'Leaf Live Fuel Moisture (%)')
exploratory_scatterplot(flamm.df.long.scatter$stem_lfm, 'Stem Live Fuel Moisture (%)')
```

## Vs. Sample Weight
```{r}
exploratory_scatterplot(flamm.df.long.scatter$sample_wt, 'Sample Weight (g)')

ggsave(here('figures', 'flamm.metrics.vs.sample.wt.exploratory.jpg'), height = 12, width = 20)
```

## Vs. Leaf Metrics
```{r}
exploratory_scatterplot(flamm.df.long.scatter$LMA, 'Leaf Mass per Area')
exploratory_scatterplot(flamm.df.long.scatter$SLA, 'Specific Leaf Area')
exploratory_scatterplot(flamm.df.long.scatter$thickness, 'Leaf Thickness')
```

# Proportion Ignited
```{r}
flamm.df %>% 
  group_by(species) %>%
  dplyr::summarise(n = n(), prop_ig = prop_ig) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) %>% 
  ggplot(aes(x = species, y = prop_ig, color = species)) +
    scale_y_continuous(limits = c(0,1)) +
    geom_point(size = 6) +
    geom_text(aes(label = n, x = species, y = prop_ig + 0.1)) +
    labs(x = ' ', y = 'Proportion Ignited') +
    theme_bw() + 
    theme(legend.position = 'none')
```

# PCAs
## Flamm Metrics
```{r}
# selecting metrics of interest
flamm_pca_df <- flamm.df %>% 
  select(fd, tti, fh, prop_ig, max_heat_flux_loessCH8, max_temp, pfg, species)

# looking at correlation and distribution
pairs.panels(flamm_pca_df)

# prepping dataset for PCA
flamm_pca_df <- flamm_pca_df %>% 
  na.omit() %>%  # Getting rid of NAs, which currently drops 113 samples :( -- need to find a way to limit
  filter(max_temp > 0) # Getting rid of -Inf values

# running PCA
flamm_pca <- flamm_pca_df %>% 
  select(-species) %>% 
  prcomp(center = TRUE, scale = TRUE) 

# first glance at results
summary(flamm_pca)
plot(flamm_pca, type = 'lines') # first 2 explain 51.86% variance
print(flamm_pca) # PC1: flame height, flame duration, max temp and max heat flux (combustibility), PC2: time to ignition, proportion ignited, post-flame glow (ignitability and consumability)

# visualizing results
ggbiplot(flamm_pca,
         groups = flamm_pca_df$species,
         ellipse = TRUE, varname.size = 5, alpha = 0.5) +
  scale_color_manual(values = c('black', 'gray50', 'goldenrod', 'skyblue', 'red', 'darkblue', 'deeppink', 'brown', 'yellowgreen')) +
  theme_bw()

# eigenvalue table
tab_pca(flamm_pca, rotation = 'varimax')
```

## Leaf Traits
```{r}
# selecting metrics of interest
traits_pca_df <- flamm.df %>% 
  select(leaf_mass_ratio, leaf_lfm, stem_lfm, lfm, thickness, mpa, SLA, sample_wt, species)

# looking at correlation and distribution
pairs.panels(traits_pca_df)

# prepping dataset for PCA
traits_pca_df <- traits_pca_df %>% 
  na.omit()  # Getting rid of NAs, which currently drops 36 samples

# running PCA
traits_pca <- traits_pca_df %>% 
  select(-species) %>% 
  prcomp(center = TRUE, scale = TRUE) 

# first glance at results
summary(traits_pca)
plot(traits_pca, type = 'lines') # first 2 explain 47.99% variance
print(traits_pca) # PC1: stem LFM, LFM, leaf mass ratio, PC2: SLA, lfm, leaf LFM, PC3: LFM, MPa

# visualizing results
ggbiplot(traits_pca,
         groups = traits_pca_df$species,
         ellipse = TRUE, varname.size = 5, alpha = 0.5) +
  scale_color_manual(values = c('black', 'gray50', 'goldenrod', 'skyblue', 'red', 'darkblue', 'deeppink', 'brown', 'yellowgreen')) +
  theme_bw()

# eigenvalue table
tab_pca(traits_pca, rotation = 'varimax')
```

# k-means Clustering
## Flamm Metrics
```{r}
# prepping dataset
id <- c(1:nrow(flamm_pca_df))
flamm_kmeans_df <- cbind(flamm_pca_df, id) %>% 
  unite('species_id', c(species, id), remove = F)

rownames(flamm_kmeans_df) <- flamm_kmeans_df$species_id

flamm_kmeans_scaled_df <- flamm_kmeans_df %>% 
  select(-c(species_id, species, id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "wss") #k = 7 or k = 4
# 2. silhouette method
fviz_nbclust(flamm_kmeans_scaled_df, kmeans, method = "silhouette") #k = 8

# run k-means clustering
#perform k-means clustering with k = 8 clusters
km <- kmeans(flamm_kmeans_scaled_df, centers = 8)
#plot results of final k-means model
fviz_cluster(km, data = flamm_kmeans_scaled_df)
#add cluster assigment to original data
flamm_kmeans_df <- cbind(flamm_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
flamm_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(flamm_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #', title = 'K-Means Clustering: Flam. Metrics')

flamm_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count', title = 'K-Means Clustering: Flam. Metrics')
```

## Leaf Traits
```{r}
# prepping dataset
id <- c(1:nrow(traits_pca_df))
traits_kmeans_df <- cbind(traits_pca_df, id) %>% 
  unite('species_id', c(species, id), remove = F)

rownames(traits_kmeans_df) <- traits_kmeans_df$species_id

traits_kmeans_scaled_df <- traits_kmeans_df %>% 
  select(-c(species_id, species, id)) %>% 
  scale() %>% 
  as.data.frame()

# optimal number of clusters
# 2 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "wss") #k = 2, 4 or 7
# 2. silhouette method
fviz_nbclust(traits_kmeans_scaled_df, kmeans, method = "silhouette") #k = 2, 4, 7, or 9

# run k-means clustering
#perform k-means clustering with k = 8 clusters (note k = 2 and k = 4 looked unhelpful)
km <- kmeans(traits_kmeans_scaled_df, centers = 7)
#plot results of final k-means model
fviz_cluster(km, data = traits_kmeans_scaled_df)
#add cluster assigment to original data
traits_kmeans_df <- cbind(traits_kmeans_df, cluster = km$cluster)

#visualizing how cluster assignment tracks species
traits_kmeans_df %>% 
  ggplot(aes(x = species, y = cluster, color = as.factor(cluster))) +
    geom_jitter(width = 0.1, height = 0.1) +
    scale_y_continuous(breaks = c(1:max(traits_kmeans_df$cluster))) +
    theme_bw() +
    labs(x = ' ', y = 'Cluster #', color = 'Cluster #', title = 'K-Means Clustering: Plant Traits')

traits_kmeans_df %>% 
  ggplot(aes(x = cluster, fill = species)) +
    geom_bar() +
    theme_bw() +
    labs(x = 'Cluster #', fill = 'Species', y = 'Count', title = 'K-Means Clustering: Plant Traits')
```

# Binomial Regressions
Looking at ignition vs. non-ignition/manual ignition
## Visualizations
```{r}
# prepping dataset
flamm_binomial_df <- flamm.df %>% 
  mutate(ignition = case_when(ignition == 'M' ~ 0,
                             ignition == '1' ~ 1,
                             ignition == '0' ~ 0)) %>% 
  filter(species %in% c('SALLEU', 'SALAPI', 'ARTCAL', 'CEAGRI', 'QUEAGR')) # focusing on species with at least 2 ignitions

# writing function
exploratory_binomial <- function(expl.var, x.lab){
  ggplot(data = flamm_binomial_df, aes(x=expl.var, y=ignition)) + 
  geom_point(alpha=.5) +
  facet_wrap(~species, scales = 'free_x') +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) +
  scale_y_continuous(breaks = c(0,1)) +
  theme_bw() +
  theme(strip.text = element_text(face = 'bold', size = 15),
        axis.title = element_text(face = 'bold', size = 16)) +
  labs(x = x.lab, y = "Ignition?", title = "Binomial Regression")}

# looking at a bunch of different explanatory variables
exploratory_binomial(flamm_binomial_df$mpa, 'Water Potential (MPa)')
exploratory_binomial(flamm_binomial_df$lfm, 'Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$leaf_lfm, 'Leaf Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$stem_lfm, 'Stem Live Fuel Moisture (%)')
exploratory_binomial(flamm_binomial_df$LMA, 'Leaf Mass Area')
exploratory_binomial(flamm_binomial_df$sample_wt, 'Sample Weight (g)')
exploratory_binomial(flamm_binomial_df$start_temp, 'Starting Temperature (C)')
```

## Significance
```{r}
# writing function
binomial_significance <- function(spp){
df <- flamm_binomial_df %>% 
  filter(species == spp)

m1 <- glm(ignition ~ lfm + sample_wt, data = df, family = "binomial")
print(paste0(spp, ': LFM P-value = ', summary(m1)$coefficients[2,4]))

m2 <- glm(ignition ~ mpa + sample_wt, data = df, family = "binomial")
print(paste0(spp,': MPa P-value = ', summary(m2)$coefficients[2,4]))

m3 <- glm(ignition ~ LMA + sample_wt, data = df, family = "binomial")
print(paste0(spp, ': LMA P-value = ', summary(m3)$coefficients[2,4]))

m4 <- glm(ignition ~ sample_wt, data = df, family = "binomial")
print(paste0(spp, ': Sample Wt. P-value = ', summary(m4)$coefficients[2,4]))

df2 <- df %>% 
  filter(start_temp > 0)
m5 <- glm(ignition ~ start_temp + sample_wt, data = df2, family = "binomial")
print(paste0(spp, ': Starting Temp. P-value = ', summary(m5)$coefficients[2,4]))
}

flamm.df %>% 
  filter(start_temp > 0) %>% 
  summarise(avg = mean(start_temp))

# Running on all species that have at least 2 ignitions
binomial_significance('SALLEU')
binomial_significance('SALAPI')
binomial_significance('ARTCAL') # sample weight, MPa are significant
binomial_significance('CEAGRI')
binomial_significance('QUEAGR')
```

# Investigating Hot Plate/Thermocoupler Height
## Hot Plate Height
```{r}
# Does it affect ignition percentage?
flamm.df.hp.ht.prop.ig1 <- flamm.df %>% 
  group_by(hotplate_height, species) %>%
  dplyr::summarise(n = n()) %>% 
  ungroup() 
  
flamm.df.hp.ht.prop.ig2 <- flamm.df %>% 
  filter(ignition %in% c('M', '0')) %>% 
  group_by(hotplate_height, species) %>% 
  dplyr::summarise(manual_or_nonignitions = n()) %>% 
  select(manual_or_nonignitions)

flamm.df.hp.ht.prop.ig <- cbind(flamm.df.hp.ht.prop.ig1, flamm.df.hp.ht.prop.ig2) %>% 
  mutate(prop_ig = (n-manual_or_nonignitions)/n)

rm(flamm.df.hp.ht.prop.ig1, flamm.df.hp.ht.prop.ig2) # Decluttering environment by removing temporary dataframes

flamm.df.hp.ht.prop.ig %>% 
  filter(n > 5) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) %>% 
  ggplot(aes(x = hotplate_height, y = prop_ig, color = species)) +
    scale_y_continuous(limits = c(0,1)) +
    scale_color_manual(values = c('black', 'gray50', 'goldenrod', 'skyblue', 'red', 'darkblue', 'deeppink', 'brown', 'yellowgreen', 'darkgreen')) +
    geom_jitter(aes(size = n), width = 0.1, height = 0) +
    #geom_text(aes(label = n, x = hotplate_height, y = prop_ig + 0.1)) +
    labs(x = 'Hot Plate Height (cm)', y = 'Proportion Ignited') +
    theme_bw()
#############################################
# For natural ignitions, does it affect time to ignition?
flamm.df %>% 
  filter(ignition == '1') %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = tti)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Time to Ignition') +
    theme_bw()
#############################################
# Does it affect max. heat flux, temp. metrics?
flamm.df %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = max_heat_flux_loessCH8)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Max. Heat Flux (Loess-Smoothed, Side Sensor)') +
    theme_bw()

flamm.df %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = max_heat_flux_loessCH7)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Max. Heat Flux (Loess-Smoothed, Top Sensor)') +
    theme_bw()

flamm.df %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = max_heat_flux)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Max. Heat Flux (Raw)') +
    theme_bw()

flamm.df %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = max_temp)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Max. Temp.') +
    theme_bw()

flamm.df %>% 
  ggplot(aes(x = as.numeric(hotplate_height), y = start_temp)) +
    geom_point() +
    geom_smooth(color = 'black') +
    labs(x = 'Hot Plate Height (cm)', y = 'Starting Temp.') +
    theme_bw()
```

## Thermocoupler Height
```{r}
# Does it affect temp. metrics?
flamm.df %>% 
  filter(max_temp > 0) %>% 
  ggplot(aes(x = as.factor(thermocoupler_height), y = max_temp)) +
    geom_jitter(width = 0.2) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA) +
    labs(x = 'Thermocoupler Height (cm)', y = 'Max. Temp.') +
    theme_bw()

flamm.df %>% 
  filter(max_temp > 0) %>% 
  ggplot(aes(x = as.factor(thermocoupler_height), y = start_temp)) +
    geom_jitter(width = 0.2) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA) +
    labs(x = 'Thermocoupler Height (cm)', y = 'Starting Temp.') +
    theme_bw()
# No, I don't think so
```

# Manual Ignitions
Looking into differences in TTI for manual ignitions and how that affects other flam. metrics
```{r}
flamm.df.manual <- flamm.df %>% 
  filter(ignition == 'M')

# First, interspecific differences in time to ignition
flamm.df.manual %>% 
  mutate(species = factor(species, levels = c('IRIDOU', 'CEAGRI', 'ARTCAL', 'MANDEN', 'SALAPI', 'MALLAU', 'SALLEU', 'ERIKAR', 'HETARB', 'QUEAGR'))) %>% 
  ggplot(aes(x = species, y = tti)) + 
    geom_jitter(width = 0.2, aes(color = species)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA) +
    labs(x = ' ', y = 'Time to Ignition') +
    theme(legend.position = 'none') +
    theme_bw()

# Now, comparing to other flam. metrics
### Prepping Dataset ###
flamm.df.manual.long <- flamm.df.manual %>% 
  select(date, species, plant, rep, fh, fd, tti, pfg, max_temp, max_heat_flux, max_heat_flux_loessCH7, max_heat_flux_loessCH8) %>%  # took out  gd, gti, ttfg for now
  pivot_longer(!c(date, species, plant, rep, tti), names_to = 'trait', values_to = 'value')
### Scatterplots ###
flamm.df.manual.long %>% 
  ggplot(aes(x = tti, y = value)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = 'lm', linewidth = 1, alpha = 0.8, se = F) +
  labs(x = 'Time to Ignition', y = 'Flamm. Metric Value', title = 'Manual Ignitions Exploratory Analysis')  +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        legend.title = element_text(face = 'bold', size = 16),
        legend.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16))
# ~~ by species ~~ #
flamm.df.manual.long %>% 
  ggplot(aes(x = tti, y = value, color = species)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = 'lm', linewidth = 1, alpha = 0.8, se = F) +
  labs(x = 'Time to Ignition', y = 'Flamm. Metric Value', color = 'Species', title = 'Manual Ignitions Exploratory Analysis')  +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        legend.title = element_text(face = 'bold', size = 16),
        legend.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16))
### Linear Regressions ###
fd.tti.lm <- lm(fd ~ tti, data = flamm.df.manual)
summary(fd.tti.lm) # sig.

fh.tti.lm <- lm(fh ~ tti, data = flamm.df.manual)
summary(fh.tti.lm) # sig.

pfg.tti.lm <- lm(pfg ~ tti, data = flamm.df.manual)
summary(pfg.tti.lm) # n.s.

mhf.tti.lm <- flamm.df.manual %>% 
  filter(max_heat_flux > 0) %>% 
  drop_na(max_heat_flux)
mhf.tti.lm <- lm(max_heat_flux ~ tti, data = mhf.tti.lm)
summary(mhf.tti.lm) # n.s.

mhfch7.tti.lm <- flamm.df.manual %>% 
  filter(max_heat_flux_loessCH7 > 0) %>% 
  drop_na(max_heat_flux_loessCH7)
mhfch7.tti.lm <- lm(max_heat_flux_loessCH7 ~ tti, data = mhfch7.tti.lm)
summary(mhfch7.tti.lm) # sig.

mhfch8.tti.lm <- flamm.df.manual %>% 
  filter(max_heat_flux_loessCH8 > 0) %>% 
  drop_na(max_heat_flux_loessCH8)
mhfch8.tti.lm <- lm(max_heat_flux_loessCH8 ~ tti, data = mhfch8.tti.lm)
summary(mhfch8.tti.lm) # sig.

mt.tti.lm <- flamm.df.manual %>% 
  filter(max_temp > 0) %>% 
  drop_na(max_temp)
mt.tti.lm <- lm(max_temp ~ tti, data = mt.tti.lm)
summary(mt.tti.lm) # n.s.
# ~~ by species ~~ #
fdxsp.tti.lm <- lm(fd ~ tti*species, data = flamm.df.manual)
summary(fdxsp.tti.lm) # n.s.
fhxsp.tti.lm <- lm(fh ~ tti*species, data = flamm.df.manual)
summary(fhxsp.tti.lm) # n.s.
pfgxsp.tti.lm <- lm(pfg ~ tti*species, data = flamm.df.manual)
summary(pfgxsp.tti.lm) # n.s.
```

# Sample Weight Exploration
First, independent of species, look into linear and nonlinear relationships with flam. metrics (for now, FD, FH, PFG) and hydration

## Linear Relationships
```{r}
## FD ## - sig.
fd.sw.lm <- lm(scale(fd) ~ scale(sample_wt), data = flamm.df)
summary(fd.sw.lm)
plot(fd.sw.lm)
ggplot(flamm.df, aes(x = sample_wt, y = fd)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  labs(x = 'Sample Wt. (g)', y = 'Flame Duration (s)') +
  theme_bw()
## FH ## - sig.
fh.sw.lm <- lm(scale(fh) ~ scale(sample_wt), data = flamm.df)
summary(fh.sw.lm)
plot(fh.sw.lm)
ggplot(flamm.df, aes(x = sample_wt, y = fh)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  labs(x = 'Sample Wt. (g)', y = 'Flame Height (cm)') +
  theme_bw()
## PFG ## - sig.
pfg.sw.lm <- lm(scale(pfg) ~ scale(sample_wt), data = flamm.df)
summary(pfg.sw.lm)
plot(pfg.sw.lm)
ggplot(flamm.df, aes(x = sample_wt, y = pfg)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  labs(x = 'Sample Wt. (g)', y = 'Post-Flame Glow (s)') +
  theme_bw()
## LFM ## - sig.
lfm.sw.lm <- lm(lfm ~ sample_wt, data = flamm.df)
summary(lfm.sw.lm)
plot(lfm.sw.lm)
ggplot(flamm.df, aes(x = sample_wt, y = lfm)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  labs(x = 'Sample Wt. (g)', y = 'Live Fuel Moisture (%)') +
  theme_bw()
## MPa ## - n.s.
mpa.sw.lm <- lm(mpa ~ sample_wt, data = flamm.df)
summary(mpa.sw.lm)
plot(mpa.sw.lm)
ggplot(flamm.df, aes(x = sample_wt, y = mpa)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  labs(x = 'Sample Wt. (g)', y = 'Water Potential (MPa)') +
  theme_bw()
```

## Nonlinear Relationships
Generalized Additive Models 1
```{r}
library(gam) # for generalized additive models

# FH
flamm.df.temp.fh <- flamm.df %>% 
  drop_na(fh, sample_wt) %>% 
  select(fh, sample_wt) %>% 
  mutate(fh = scale(fh), sample_wt = scale(sample_wt))
fh.sw.gam <- gam(fh ~ s(sample_wt), data = flamm.df.temp.fh)
summary(fh.sw.gam) 
flamm.df.temp.fh$predict.gam.fh <- predict.Gam(fh.sw.gam)
ggplot(data = flamm.df.temp.fh) +
  geom_point(aes(x = sample_wt, y = predict.gam.fh), color = 'black') +
  geom_point(aes(x = sample_wt, y = fh), alpha = 0.5, color = 'gray50')

# FD
flamm.df.temp.fd <- flamm.df %>% 
  drop_na(fd, sample_wt) %>% 
  select(fd, sample_wt) %>% 
  mutate(fd = scale(fd), sample_wt = scale(sample_wt))
fd.sw.gam <- gam(fd ~ s(sample_wt), data = flamm.df.temp.fd)
summary(fd.sw.gam)
flamm.df.temp.fd$predict.gam.fd <- predict.Gam(fd.sw.gam)
ggplot(data = flamm.df.temp.fd) +
  geom_point(aes(x = sample_wt, y = predict.gam.fd), color = 'black') +
  geom_point(aes(x = sample_wt, y = fd), alpha = 0.5, color = 'gray50')

# PFG
flamm.df.temp.pfg <- flamm.df %>% 
  drop_na(pfg, sample_wt) %>% 
  select(pfg, sample_wt) %>% 
  mutate(pfg = scale(pfg), sample_wt = scale(sample_wt))
pfg.sw.gam <- gam(pfg ~ s(sample_wt), data = flamm.df.temp.pfg)
summary(pfg.sw.gam)
flamm.df.temp.pfg$predict.gam.pfg <- predict.Gam(pfg.sw.gam)
ggplot(data = flamm.df.temp.pfg) +
  geom_point(aes(x = sample_wt, y = predict.gam.pfg), color = 'black') +
  geom_point(aes(x = sample_wt, y = pfg), alpha = 0.5, color = 'gray50')
```

Generalized Additive Models 2
```{r}
# FH
fh.sw.gam <- gam(fh ~ lo(sample_wt), data = flamm.df.temp.fh)
summary(fh.sw.gam)
flamm.df.temp.fh$predict.gam.fh <- predict.Gam(fh.sw.gam)
ggplot(data = flamm.df.temp.fh) +
  geom_point(aes(x = sample_wt, y = predict.gam.fh), color = 'black') +
  geom_point(aes(x = sample_wt, y = fh), alpha = 0.5, color = 'gray50')

# FD
fd.sw.gam <- gam(fd ~ lo(sample_wt), data = flamm.df.temp.fd)
summary(fd.sw.gam)
flamm.df.temp.fd$predict.gam.fd <- predict.Gam(fd.sw.gam)
ggplot(data = flamm.df.temp.fd) +
  geom_point(aes(x = sample_wt, y = predict.gam.fd), color = 'black') +
  geom_point(aes(x = sample_wt, y = fd), alpha = 0.5, color = 'gray50')

# PFG
pfg.sw.gam <- gam(pfg ~ lo(sample_wt), data = flamm.df.temp.pfg)
summary(pfg.sw.gam)
flamm.df.temp.pfg$predict.gam.pfg <- predict.Gam(pfg.sw.gam)
ggplot(data = flamm.df.temp.pfg) +
  geom_point(aes(x = sample_wt, y = predict.gam.pfg), color = 'black') +
  geom_point(aes(x = sample_wt, y = pfg), alpha = 0.5, color = 'gray50')
```

Polynomial Regressions
```{r}
# First, testing for which degree gives us best results
fh.poly.aic <- (rep(NA, 5))
for(i in 1:5){
fh.sw.poly <- lm(data = flamm.df.temp.fh, fh ~ poly(sample_wt, i))
fh.poly.aic[i] <- AIC(fh.sw.poly)
}
fh.poly.aic # degrees = 3

fd.poly.aic <- (rep(NA, 5))
for(i in 1:5){
fd.sw.poly <- lm(data = flamm.df.temp.fd, fd ~ poly(sample_wt, i))
fd.poly.aic[i] <- AIC(fd.sw.poly)
}
fd.poly.aic # degrees = 3

pfg.poly.aic <- (rep(NA, 5))
for(i in 1:5){
pfg.sw.poly <- lm(data = flamm.df.temp.pfg, pfg ~ poly(sample_wt, i))
pfg.poly.aic[i] <- AIC(pfg.sw.poly)
}
pfg.poly.aic # linear is best, but since others are degrees = 3, we'll look into that one for all three metrics

# Running models
fh.sw.poly <- lm(data = flamm.df.temp.fh, fh ~ poly(sample_wt, 3))
summary(fh.sw.poly)
fd.sw.poly <- lm(data = flamm.df.temp.fd, fd ~ poly(sample_wt, 3))
summary(fd.sw.poly)
pfg.sw.poly <- lm(data = flamm.df.temp.pfg, pfg ~ poly(sample_wt, 3))
summary(pfg.sw.poly)
```


## Binned Sample Weights
```{r}
# Data wrangling
quantile(flamm.df$sample_wt, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)

flamm.df <- flamm.df %>% 
  mutate(sample_wt_bins = case_when(
    sample_wt <= 1.1064 ~ '0.2264-1.1064',
    sample_wt > 1.1064 & sample_wt <= 2.8064  ~ '1.1064-2.8064',
    sample_wt > 2.8064 & sample_wt <= 8.4864 ~ '2.8064-8.4864',
    sample_wt > 8.4864 & sample_wt <= 30.5664 ~ '8.4864-30.5664',
  ))

# LMA
flamm.df %>% 
  filter(LMA < 2.5) %>% 
  drop_na(sample_wt_bins)%>% 
ggplot(aes(x = LMA, y = fh)) +
  labs(x = 'Leaf Mass per Area', y = 'Flame Height (cm)') +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~sample_wt_bins, scales = 'free_x') +
  theme_bw()

flamm.df %>% 
  filter(LMA < 2.5) %>% 
  drop_na(sample_wt_bins)%>% 
ggplot(aes(x = LMA, y = fd)) +
  labs(x = 'Leaf Mass per Area', y = 'Flame Duration (s)') +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~sample_wt_bins, scales = 'free_x') +
  theme_bw()

# Leaf Mass Ratio
flamm.df %>% 
  drop_na(sample_wt_bins)%>% 
ggplot(aes(x = leaf_mass_ratio, y = fh)) +
  labs(x = 'Leaf Mass Ratio', y = 'Flame Height (cm)') +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~sample_wt_bins, scales = 'free_x') +
  theme_bw()

flamm.df %>% 
  drop_na(sample_wt_bins)%>% 
ggplot(aes(x = leaf_mass_ratio, y = fd)) +
  labs(x = 'Leaf Mass Ratio', y = 'Flame Duration (s)') +
  geom_point() +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~sample_wt_bins, scales = 'free_x') +
  theme_bw()
```

## Different transformations
```{r}
library(scales)
flamm.df.sw <- flamm.df %>% 
  mutate(fh = scales::rescale(fh),
         fd = scales::rescale(fd),
         pfg = scales::rescale(pfg),
         sample_wt = scales::rescale(sample_wt)) %>% 
  mutate(fh.norm = fh/sample_wt,
         fd.norm = fd/sample_wt,
         pfg.norm = pfg/sample_wt) %>% 
  mutate(fh.norm.sqrt = fh/(1+sample_wt^1/2),
         fd.norm.sqrt = fd/(1+sample_wt^1/2),
         pfg.norm.sqrt = pfg/(1+sample_wt^1/2)) %>% 
  mutate(fh.norm.cube.root = fh/(1+sample_wt^1/3),
         fd.norm.cube.root = fd/(1+sample_wt^1/3),
         pfg.norm.cube.root = pfg/(1+sample_wt^1/3))

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fh)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fh.norm)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fh.norm.sqrt)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fh.norm.cube.root)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fd)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fd.norm)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fd.norm.sqrt)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = fd.norm.cube.root)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = pfg)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = pfg.norm)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = pfg.norm.sqrt)) +
    geom_point()

flamm.df.sw %>% 
  ggplot(aes(x = sample_wt, y = pfg.norm.cube.root)) +
    geom_point()

flamm.df.sw.long <- flamm.df.sw %>% 
  select(date, species, plant, rep, mpa, leaf_lfm, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt, fh, fd, pfg, fh.norm, fd.norm, pfg.norm, fh.norm.sqrt, fd.norm.sqrt, pfg.norm.sqrt, fh.norm.cube.root, fd.norm.cube.root, pfg.norm.cube.root) %>% 
  pivot_longer(!c(date, species, plant, rep, mpa, leaf_lfm, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt), names_to = 'trait', values_to = 'value') %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUCGLO', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) #note that EUGL needs to change to EUCGLO

flamm.df.sw.long %>% 
ggplot(aes(x = species, y = value, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Trait Value") +
  facet_wrap(~trait, ncol = 4, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))

flamm.df.sw.long %>% 
ggplot(aes(x = species, y = sample_wt, color = species)) +
  geom_boxplot() +
  labs(x = "Species", y = "Sample Weight (g)") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        strip.text = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(angle = 20, size = 12))
```

# Sample Dry Weight/Wet Weight
```{r}
# Calculating the metrics
flamm.df <- flamm.df %>% 
  mutate(wet_mass = stem_wet_mass + leaf_wet_mass,
         dry_mass = stem_dry_mass + leaf_dry_mass,
         gdw_gfw = dry_mass/(wet_mass+dry_mass),
         dw_flam_sample = gdw_gfw * sample_wt, # need to change to sample weight
         ww_flam_sample = sample_wt - dw_flam_sample)

# Boxplots
ggplot(flamm.df, aes(x = species, color = species, y = dw_flam_sample)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
  labs(x = "Species", y = "Dry Weight (g)") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(angle = 20, size = 12))

ggplot(flamm.df, aes(x = species, color = species, y = ww_flam_sample)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
  labs(x = "Species", y = "Wet Weight (g)") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(angle = 20, size = 12))

# Scatterplots
flamm.df.long.scatter <- flamm.df %>% 
  select(date, species, plant, rep, mpa, branching, branch_height, branch_length, branch_width, leaf_lfm, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt, fh, fd, tti, pfg, max_temp, max_heat_flux, max_heat_flux_loessCH7, max_heat_flux_loessCH8, dw_flam_sample, ww_flam_sample) %>%  # took out  gd, gti, ttfg for now
  pivot_longer(!c(date, species, plant, rep, mpa, branching, branch_height, branch_length, branch_width, leaf_lfm, stem_lfm, lfm, LMA, SLA, thickness, sample_wt, dw_flam_sample, ww_flam_sample), names_to = 'trait', values_to = 'value') %>% 
  filter(trait %in% c('fd', 'fh', 'max_temp', 'pfg')) %>% 
  mutate(species = factor(species, levels = c('SALAPI', 'SALLEU', 'CEAGRI', 'ARTCAL', 'QUEAGR', 'MALLAU', 'EUCGLO', 'ERIKAR', 'HETARB', 'IRIDOU', 'MANDEN'))) #note that EUGL needs to change to EUCGLO

exploratory_scatterplot(flamm.df.long.scatter$dw_flam_sample, 'Dry Weight (g)')
exploratory_scatterplot(flamm.df.long.scatter$ww_flam_sample, 'Wet Weight (g)')
```

It seems like sample weight is driving these relationships far more than hydration/dryness. Let's try some corrections:
```{r}
ggplot(flamm.df, aes(y = fh/dw_flam_sample, x = dw_flam_sample)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 350)+ 
  stat_regline_equation(label.y = 400) +
  labs(y = "Flame Height/Dry Weight", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(y = log(fh/dw_flam_sample), x = dw_flam_sample)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 7)+ 
  stat_regline_equation(label.y = 8) +
  labs(y = "Flame Height/Dry Weight (log-transformed)", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(y = fh/1 + dw_flam_sample, x = dw_flam_sample)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 65)+ 
  stat_regline_equation(label.y = 75) +
  labs(y = "Flame Height/1 + Dry Weight", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

flamm.df %>% 
  filter(lfm < 500) %>% 
  ggplot(aes(x = lfm, y = fh/dw_flam_sample)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 175)+ 
  stat_regline_equation(label.y = 200) +
  labs(x = "Live Fuel Moisture (%)", y = "Flame Height/Dry Weight (cm/g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

By species
```{r}
ggplot(flamm.df, aes(y = fh/dw_flam_sample, x = dw_flam_sample, color = species)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  stat_cor(label.y = c(450, 428, 406, 384, 363, 362, 340, 318, 296, 274),label.x = 5) + 
  stat_regline_equation(label.y = c(450, 428, 406, 384, 363, 362, 340, 318, 296, 274), 
                        label.x = 1.5) +
  labs(y = "Flame Height/Dry Weight", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(y = log(fh/dw_flam_sample), x = dw_flam_sample, color = species)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  stat_cor(label.y = c(8.5, 8, 7.5, 7, 6.6, 6.5, 6, 5.5, 5, 4.5),label.x = 4.5) + 
  stat_regline_equation(label.y = c(8.5, 8, 7.5, 7, 6.6, 6.5, 6, 5.5, 5, 4.5), label.x = 1.5) +
  labs(y = "Flame Height/Dry Weight (log-transformed)", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(y = fh/1 + dw_flam_sample, x = dw_flam_sample, color = species)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  stat_cor(label.y = c(120, 115, 110, 105, 101, 100, 95, 90, 85, 80),label.x = 3) + 
  stat_regline_equation(label.y = c(120, 115, 110, 105, 101, 100, 95, 90, 85, 80)) +
  labs(y = "Flame Height/1 + Dry Weight", x = "Dry Weight (g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

flamm.df %>% 
  filter(lfm < 500) %>% 
  ggplot(aes(x = lfm, y = fh/dw_flam_sample, color = species)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  stat_cor(label.y = c(250, 240, 230, 220, 210, 200, 190, 180, 170, 160),label.x = 200) + 
  stat_regline_equation(label.y = c(250, 240, 230, 220, 210, 200, 190, 180, 170, 160)) +
  labs(x = "Live Fuel Moisture (%)", y = "Flame Height/Dry Weight (cm/g)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

Polynomial Regression - FH vs. DW
```{r}
flamm.df.temp.fh <- flamm.df %>% 
  drop_na(fh, dw_flam_sample)
# First, testing for which degree gives us best results
fh.poly.aic <- (rep(NA, 5))
for(i in 1:5){
fh.sw.poly <- lm(data = flamm.df.temp.fh, fh ~ poly(dw_flam_sample, i))
fh.poly.aic[i] <- AIC(fh.sw.poly)
}
fh.poly.aic # degrees = 5

fh.dw.poly <- lm(data = flamm.df.temp.fh, fh ~ poly(dw_flam_sample, 5))
summary(fh.dw.poly)

flamm.df.temp.fh$predict.poly.fh <- predict(fh.dw.poly)
ggplot(data = flamm.df.temp.fh) +
  geom_point(aes(x = dw_flam_sample, y = predict.poly.fh), color = 'black') +
  geom_point(aes(x = dw_flam_sample, y = fh), alpha = 0.5, color = 'gray50') +
  theme_bw() +
  labs(y = 'Flame Height (cm)', x = 'Dry Weight (g)') +
  annotate('text', x = 4, y = 80, label = 'Note: black points = polynomial regression') +
  annotate('text', x = 4, y = 75, label = 'Adjusted R^2 = 0.537, p < 2.2e-16') +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

# Residuals
flamm.df.temp.fh <- flamm.df.temp.fh %>% 
  mutate(fh.dev.poly = fh - predict.poly.fh)

flamm.df.temp.fh %>% 
  ggplot(aes(x = dw_flam_sample, y = fh.dev.poly)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 27)+ 
  stat_regline_equation(label.y = 30) +
  labs(x = "Dry Weight (g)", y = "FH~DW Polynomial Residuals") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

flamm.df.temp.fh %>% 
  ggplot(aes(x = mpa, y = fh.dev.poly)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 27)+ 
  stat_regline_equation(label.y = 30) +
  labs(x = "Water Potential (MPa)", y = "FH~DW Polynomial Residuals") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

flamm.df.temp.fh %>% 
  ggplot(aes(x = mpa, y = fh)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 75)+ 
  stat_regline_equation(label.y = 80) +
  labs(x = "Water Potential (MPa)", y = "Flame Height (cm)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

flamm.df.temp.fh %>% 
  mutate(species = factor(species, levels = c('IRIDOU', 'CEAGRI', 'ARTCAL', 'MANDEN', 'SALAPI', 'MALLAU', 'SALLEU', 'ERIKAR', 'HETARB', 'QUEAGR'))) %>% 
  ggplot(aes(x = species, y = fh.dev.poly)) + 
    geom_jitter(width = 0.2, aes(color = species)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA) +
    labs(x = ' ', y = 'FH~DW Polynomial Residuals') +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 15))
```


# Plant Traits Exploratory Analyses
Zoe is working on leaf area, LMA, SLA, etc. and I'm focusing on branching, branch width, length, VOCs
## Branching
```{r}
exploratory_scatterplot(flamm.df.long.scatter$branching, 'Branching') # right away, it looks like maybe flame height could relate to branching

ggplot(flamm.df, aes(x = branching, y = fh)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  scale_x_continuous(limits = c(0, 16)) +
  stat_cor(label.y = 72)+ 
  stat_regline_equation(label.y = 80) +
  labs(x = "Branching", y = "Flame Height (cm)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(x = branching, y = fd)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  scale_x_continuous(limits = c(0, 16)) +
  stat_cor(label.y = 90)+ 
  stat_regline_equation(label.y = 95) +
  labs(x = "Branching", y = "Flame Duration (s)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(x = species, y = branching, color = species)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
  labs(x = " ", y = "Sample Volume") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))

flamm.df %>% 
  filter(species != 'IRIDOU') %>% 
  ggplot(aes(x = branching, y = fh)) +
    geom_point() +
    geom_smooth(method = 'lm', color = 'gray40') +
    facet_wrap(~species, scales = 'free_x') +
    stat_cor(label.y = 72)+ 
    stat_regline_equation(label.y = 80) +
    labs(x = "Branching", y = "Flame Height (cm)") +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Sample Volume
```{r}
flamm.df <- flamm.df %>% 
  mutate(branch_volume = branch_length*branch_width*branch_height)

ggplot(flamm.df, aes(x = species, y = branch_volume, color = species)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
  labs(x = " ", y = "Sample Volume") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))

ggplot(flamm.df, aes(x = species, y = log(branch_volume), color = species)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
  labs(x = " ", y = "Sample Volume (log-transformed)") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))

ggplot(flamm.df, aes(x = branch_volume, y = fh)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 72)+ 
  stat_regline_equation(label.y = 80) +
  labs(x = "Sample Volume", y = "Flame Height (cm)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

ggplot(flamm.df, aes(x = branch_volume, y = fd)) +
  geom_point() +
  geom_smooth(method = 'lm', color = 'gray40') +
  stat_cor(label.y = 90)+ 
  stat_regline_equation(label.y = 95) +
  labs(x = "Sample Volume", y = "Flame Duration (s)") +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Correlations
```{r}
library(GGally) # For ggcorr()
flamm.df %>% 
  filter(lfm < 500) %>% 
  select(fh, fd, pfg, prop_ig, lfm, leaf_lfm, stem_lfm, LMA, thickness, branch_height, branch_width, branch_length, branch_volume, branching, mpa, sample_wt, stem_mass_ratio, thickness) %>% 
  ggcorr(label = T)
```

Looking into strange correlations/lack of correlations
```{r}
flamm.df %>% 
  filter(lfm < 500) %>% 
    ggplot(aes(x = thickness, y = prop_ig)) +
      geom_point(alpha = 0.4) +
      geom_smooth()

flamm.df %>% 
  filter(start_temp > 10) %>% 
ggplot(aes(x = date, y = start_temp)) +
  geom_jitter(width = 0.1, height = 0.1, aes(color = species)) +
  geom_violin(alpha = 0.4) +
  theme_bw() +
  labs(x = 'Date', y = 'Starting Temp. (C)', color = 'Species')

flamm.df %>% 
ggplot(aes(x = as.factor(pre_ignition_glow), y = fd)) +
  facet_wrap(~species, scales = 'free_y') +
  geom_jitter(width = 0.1, height = 0.1, aes(color = species)) +
  geom_boxplot(alpha = 0.4) +
  theme_bw() +
  labs(x = 'Pre-ignition Glow?', y = 'Flame Duration (s)', color = 'Species')
```

